<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Rogue21 - Blackjack mit Upgrades</title>
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #1a1a1a; color: #f0f0f0; margin: 20px; }
        .container { max-width: 800px; margin: auto; background-color: #2c2c2c; padding: 20px; border-radius: 10px; }
        h1, h2 { color: #ffd700; border-bottom: 2px solid #555; padding-bottom: 5px; }
        button { background-color: #4CAF50; color: white; padding: 10px 15px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        .card { display: inline-block; padding: 10px; margin: 5px; border: 1px solid #777; border-radius: 5px; background-color: white; color: black; font-weight: bold; }
        .status, .output { margin-top: 15px; padding: 10px; border: 1px dashed #666; }
        
        /* Seltenheits-Farben für Shop */
        .Gewöhnlich { color: #2ecc71; } /* Grün */
        .Ungewöhnlich { color: #3498db; } /* Blau */
        .Selten { color: #f1c40f; } /* Gelb/Gold */
        .Episch { color: #9b59b6; } /* Lila */
        .Legendär { color: #e67e22; } /* Orange */

        /* Blackjack Animation */
        .blackjack-animation { 
            color: #ff4500; 
            font-size: 24px; 
            font-weight: bold; 
            text-align: center;
            border: 4px double #ff4500;
            padding: 10px;
            margin: 10px 0;
            animation: pulse 1s infinite alternate; 
        }
        @keyframes pulse {
            from { transform: scale(1); box-shadow: 0 0 10px #ff4500; }
            to { transform: scale(1.05); box-shadow: 0 0 20px #ff4500; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>🃏 Rogue21</h1>
    <div class="status" id="status-display"></div>
    
    <div id="main-menu">
        <h2>Hauptmenü</h2>
        <button onclick="startGame()">▶️ Spielen</button>
        <button onclick="showShop()">🛒 Shop</button>
        <button onclick="document.getElementById('main-menu').style.display='none'; document.getElementById('game-area').style.display='none'; alert('Spiel beendet!');">🚪 Beenden</button>
    </div>

    <div id="game-setup" style="display: none;">
        <h2>Wette setzen</h2>
        <input type="number" id="bet-input" value="10" min="10" max="100">
        <button onclick="startRound()">Wette Bestätigen</button>
        <button onclick="showMainMenu()">Zurück</button>
        <p id="bet-message"></p>
    </div>

    <div id="game-area" style="display: none;">
        <div id="dealer-hand"></div>
        <div id="player-hands"></div>
        <div class="output" id="game-output"></div>

        <h2>Aktionen</h2>
        <button id="hit-btn" onclick="hit()">➕ Hit (Karte ziehen)</button>
        <button id="stand-btn" onclick="stand()">🛑 Stand (Stehenbleiben)</button>
        <button id="double-btn" onclick="doubleDown()">💰 Double Down (Verdoppelt Goldgewinn diese Runde)</button>
        <button id="split-btn" onclick="split()">✂️ Split (Teilen)</button>
        <button id="token-btn" onclick="useToken()" style="display:none;">🔮 Voraussicht-Token</button>
        
        <button onclick="endTurn()" style="display: none;" id="continue-btn">➡️ Weiter zur Auswertung</button>
    </div>

    <div id="shop-area" style="display: none;">
        <h2>🛒 Rogue21 Shop</h2>
        <ul id="shop-list" style="list-style: none; padding: 0;">
            </ul>
        <button onclick="showMainMenu()">Zurück zum Menü</button>
    </div>
</div>

<script>
// --- SPIELKONSTANTEN UND GLOBALE ZUSTÄNDE ---
const SPIELNAME = "Rogue21";
const WETT_MIN = 10;
const WETT_MAX = 100;

let playerGold = 100;
let playerHP = 3;
let playerInventory = [];
let currentSkin = "Standard";
let deck = [];

let playerHands = []; // Struktur: [{cards: [], bet: 0, status: 'playing'}, ...]
let dealerHand = [];
let currentHandIndex = 0;
let dealerRisk = false; // Für "Händler-Provokation"

// Seltenheiten für den Shop (Farbe ist der CSS-Klassenname)
const SELTENHEITEN = {
    'Gewöhnlich': { klasse: 'Gewöhnlich', chance: 0.50 },
    'Ungewöhnlich': { klasse: 'Ungewöhnlich', chance: 0.30 },
    'Selten': { klasse: 'Selten', chance: 0.15 },
    'Episch': { klasse: 'Episch', chance: 0.04 },
    'Legendär': { klasse: 'Legendär', chance: 0.01 }
};

// Shop-Gegenstände
const SHOP_GEGENSTAENDE = {
    "Rogue-Skin (Keanu)": { kosten: 100, effekt: "Visuell", seltenheit: "Gewöhnlich" },
    "Rogue-Skin (Terminator)": { kosten: 150, effekt: "Visuell", seltenheit: "Ungewöhnlich" },
    "Glücks-Multiplikator": { kosten: 180, effekt: "Blackjack: 2:1 (Passiv)", seltenheit: "Selten" },
    "Amulett der Erlösung": { kosten: 350, effekt: "Verhindert einmalig 0 HP (Passiv)", seltenheit: "Episch" },
    "Voraussicht-Token": { kosten: 50, effekt: "Nächste Karte sehen und entscheiden (einmalig)", seltenheit: "Gewöhnlich" },
    "Händler-Provokation": { kosten: 400, effekt: "Dealer spielt risikoreicher (einmalig)", seltenheit: "Legendär" }
};

// --- HILFSFUNKTIONEN ---

function getCardValue(card) {
    const rank = card.split('')[0]; // Z.B. 'A', '10', 'K'
    if (['K', 'D', 'B'].includes(rank) || rank.length > 1) return 10;
    if (rank === 'A') return 11;
    return parseInt(rank);
}

function calculateHandValue(hand) {
    let value = 0;
    let aces = 0;
    hand.forEach(card => {
        value += getCardValue(card);
        if (card.startsWith('A')) aces++;
    });

    while (value > 21 && aces > 0) {
        value -= 10;
        aces--;
    }
    return value;
}

function createDeck() {
    const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'B', 'D', 'K'];
    const suits = ['♥', '♦', '♣', '♠'];
    let newDeck = [];
    for (let i = 0; i < 4; i++) { // 4 Decks
        suits.forEach(suit => {
            ranks.forEach(rank => {
                newDeck.push(rank + suit);
            });
        });
    }
    // Mischen (Fisher-Yates)
    for (let i = newDeck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newDeck[i], newDeck[j]] = [newDeck[j], newDeck[i]];
    }
    return newDeck;
}

function drawCard() {
    return deck.pop();
}

// --- DISPLAY FUNKTIONEN ---

function renderStatus() {
    const passivEffects = [];
    if (playerInventory.includes("Glücks-Multiplikator")) passivEffects.push("Blackjack: 2:1");
    if (playerInventory.includes("Amulett der Erlösung")) passivEffects.push("Todesverhinderung");
    
    const inventoryList = playerInventory
        .filter(item => !["Glücks-Multiplikator", "Amulett der Erlösung"].includes(item))
        .join(', ');

    document.getElementById('status-display').innerHTML = `
        <h2>Spielerstatus</h2>
        <p>💰 Gold: ${playerGold}</p>
        <p>❤️ HP: ${playerHP}</p>
        <p>🎭 Skin: ${currentSkin}</p>
        <p>🎒 Inventar: ${inventoryList || 'Leer'}</p>
        <p>✨ Passiv: ${passivEffects.join(', ') || 'Keine'}</p>
    `;
}

function renderHands() {
    let dealerHTML = `<h2>Dealer (Wert: ${dealerHand.length > 0 && playerHands.length > 0 && playerHands[currentHandIndex].status === 'playing' ? '?' : calculateHandValue(dealerHand)})</h2>`;
    dealerHand.forEach((card, index) => {
        if (index === 1 && playerHands.length > 0 && playerHands[currentHandIndex].status === 'playing') {
            dealerHTML += `<span class="card">[???]</span>`;
        } else {
            dealerHTML += `<span class="card">${card}</span>`;
        }
    });
    document.getElementById('dealer-hand').innerHTML = dealerHTML;

    let playerHTML = '<h2>Deine Hände</h2>';
    playerHands.forEach((hand, index) => {
        const activeClass = index === currentHandIndex && hand.status === 'playing' ? 'style="border: 3px solid #ffd700;"' : '';
        const handValue = calculateHandValue(hand.cards);
        
        playerHTML += `<div class="hand" ${activeClass}>`;
        playerHTML += `<h4>Hand ${index + 1} (Wette: ${hand.bet} Gold, Wert: ${handValue}) - Status: ${hand.status.toUpperCase()}</h4>`;
        hand.cards.forEach(card => {
            playerHTML += `<span class="card">${card}</span>`;
        });
        playerHTML += `</div>`;
    });
    document.getElementById('player-hands').innerHTML = playerHTML;
}

function updateGameOutput(message, isBlackjack = false) {
    const outputDiv = document.getElementById('game-output');
    if (isBlackjack) {
        outputDiv.innerHTML += `<div class="blackjack-animation">💥 BLACKJACK!!! 🎊🎉 WIRKLICH COOL! 🎉🎊</div>`;
    } else {
        outputDiv.innerHTML += `<p>${message}</p>`;
    }
    outputDiv.scrollTop = outputDiv.scrollHeight;
}

function enableActions(enable) {
    document.getElementById('hit-btn').disabled = !enable;
    document.getElementById('stand-btn').disabled = !enable;
    
    // Double Down nur bei 2 Karten und genug Gold
    const currentHand = playerHands[currentHandIndex];
    const canDouble = enable && currentHand && currentHand.cards.length === 2 && playerGold >= currentHand.bet;
    document.getElementById('double-btn').disabled = !canDouble;
    document.getElementById('double-btn').textContent = canDouble 
        ? `💰 Double Down (Verdoppelt Goldgewinn diese Runde - Kostet ${currentHand.bet} Gold)` 
        : '💰 Double Down';

    // Split nur bei 2 gleichen Karten und genug Gold
    const canSplit = enable && currentHand && currentHand.cards.length === 2 && getCardValue(currentHand.cards[0]) === getCardValue(currentHand.cards[1]) && playerGold >= currentHand.bet;
    document.getElementById('split-btn').disabled = !canSplit;

    // Token nur, wenn im Inventar
    const tokenBtn = document.getElementById('token-btn');
    const canUseToken = enable && playerInventory.includes("Voraussicht-Token");
    tokenBtn.style.display = canUseToken ? 'inline-block' : 'none';
}

function showMainMenu() {
    document.getElementById('main-menu').style.display = 'block';
    document.getElementById('game-setup').style.display = 'none';
    document.getElementById('game-area').style.display = 'none';
    document.getElementById('shop-area').style.display = 'none';
    renderStatus();
}

// --- SPIEL LOGIK ---

function startGame() {
    document.getElementById('main-menu').style.display = 'none';
    document.getElementById('game-setup').style.display = 'block';
    document.getElementById('game-area').style.display = 'none';
    document.getElementById('bet-input').max = Math.min(WETT_MAX, playerGold);
    document.getElementById('bet-message').textContent = `Wähle eine Wette zwischen ${WETT_MIN} und ${Math.min(WETT_MAX, playerGold)} Gold.`;
    renderStatus();
}

function startRound() {
    const betInput = document.getElementById('bet-input');
    let bet = parseInt(betInput.value);

    if (isNaN(bet) || bet < WETT_MIN || bet > WETT_MAX || bet > playerGold) {
        alert(`Ungültige Wette! Min: ${WETT_MIN}, Max: ${WETT_MAX}, Dein Gold: ${playerGold}`);
        return;
    }

    // Zustand zurücksetzen
    deck = createDeck();
    dealerHand = [];
    playerHands = [];
    currentHandIndex = 0;
    document.getElementById('game-output').innerHTML = '';
    dealerRisk = playerInventory.includes("Händler-Provokation");

    // Karten austeilen
    playerHands.push({ cards: [drawCard(), drawCard()], bet: bet, status: 'playing' });
    dealerHand = [drawCard(), drawCard()];
    playerGold -= bet;

    // UI Wechsel
    document.getElementById('game-setup').style.display = 'none';
    document.getElementById('game-area').style.display = 'block';
    document.getElementById('continue-btn').style.display = 'none';
    
    // Blackjack Prüfung
    const playerValue = calculateHandValue(playerHands[0].cards);
    const dealerValue = calculateHandValue(dealerHand);

    renderHands();
    
    if (playerValue === 21) {
        updateGameOutput("Spieler hat Blackjack!", true);
        enableActions(false);
        setTimeout(endTurn, 3000); // 3 Sekunden warten für Animation
    } else {
        updateGameOutput(`Starte Runde. Deine Wette: ${bet} Gold.`);
        enableActions(true);
    }
    renderStatus();
}

// --- SPIELER AKTIONEN ---

function hit() {
    const currentHand = playerHands[currentHandIndex];
    if (currentHand.status !== 'playing') return;

    currentHand.cards.push(drawCard());
    updateGameOutput(`Du ziehst eine Karte für Hand ${currentHandIndex + 1}.`);
    
    const value = calculateHandValue(currentHand.cards);
    renderHands();

    if (value > 21) {
        currentHand.status = 'busted';
        updateGameOutput(`Hand ${currentHandIndex + 1} ist überkauft (Bust: ${value}).`);
        nextHandOrEndTurn();
    } else if (value === 21) {
        currentHand.status = 'stand';
        updateGameOutput(`Hand ${currentHandIndex + 1} hat 21 Punkte.`);
        nextHandOrEndTurn();
    } else {
        enableActions(true);
    }
}

function stand() {
    const currentHand = playerHands[currentHandIndex];
    if (currentHand.status !== 'playing') return;

    currentHand.status = 'stand';
    updateGameOutput(`Du bleibst stehen bei Hand ${currentHandIndex + 1}.`);
    nextHandOrEndTurn();
}

function doubleDown() {
    const currentHand = playerHands[currentHandIndex];
    if (currentHand.status !== 'playing' || currentHand.cards.length !== 2 || playerGold < currentHand.bet) return;

    // Einsatz verdoppeln und Gold abziehen
    playerGold -= currentHand.bet;
    currentHand.bet *= 2;
    
    // Nur eine Karte ziehen
    currentHand.cards.push(drawCard());
    updateGameOutput(`🚀 Double Down! Neuer Einsatz: ${currentHand.bet} Gold. Nur eine Karte gezogen.`);
    
    const value = calculateHandValue(currentHand.cards);
    renderHands();

    if (value > 21) {
        currentHand.status = 'busted';
        updateGameOutput(`Hand ${currentHandIndex + 1} ist überkauft (Bust: ${value}).`);
    } else {
        currentHand.status = 'stand';
    }
    nextHandOrEndTurn();
}

function split() {
    const currentHand = playerHands[currentHandIndex];
    if (currentHand.status !== 'playing' || currentHand.cards.length !== 2 || getCardValue(currentHand.cards[0]) !== getCardValue(currentHand.cards[1]) || playerGold < currentHand.bet) return;
    
    const originalBet = currentHand.bet;
    playerGold -= originalBet; // Zusätzlichen Einsatz abziehen
    
    const card1 = currentHand.cards[0];
    const card2 = currentHand.cards[1];

    // Neue Hände erstellen und erste Karte ziehen
    const newHand1 = { cards: [card1, drawCard()], bet: originalBet, status: 'playing' };
    const newHand2 = { cards: [card2, drawCard()], bet: originalBet, status: 'playing' };

    // Aktuelle Hand ersetzen und neue Hand hinzufügen
    playerHands.splice(currentHandIndex, 1, newHand1, newHand2);
    updateGameOutput("✂️ Split! Die Hand wurde in zwei getrennte Hände aufgeteilt.");

    // Sonderregel für Asse: sofortiger Stand nach dem Split
    if (card1.startsWith('A')) {
        newHand1.status = 'stand';
        newHand2.status = 'stand';
        updateGameOutput("♠️ Asse geteilt! Nur eine Karte pro Hand. Stehenbleiben erzwungen.");
    }

    renderHands();
    nextHandOrEndTurn(true); // Mit True wird Hand 1 direkt gestartet (da Hand 0 ersetzt wurde)
}

function useToken() {
    if (!playerInventory.includes("Voraussicht-Token")) return;

    const nextCard = deck[deck.length - 1];
    const userChoice = confirm(`🔮 Die nächste Karte im Deck ist: [${nextCard}]. Möchtest du diese Karte ziehen?`);
    
    playerInventory.splice(playerInventory.indexOf("Voraussicht-Token"), 1);
    updateGameOutput(`Token verbraucht.`);
    
    if (userChoice) {
        hit(); // Ruft hit() auf, das die Karte zieht und die Runde weiterführt
    } else {
        updateGameOutput("Du hast dich entschieden, die Karte nicht zu ziehen. Spiele weiter.");
        renderStatus();
    }
    // Nach Nutzung Token-Button ausblenden
    document.getElementById('token-btn').style.display = 'none';
}


function nextHandOrEndTurn(isSplit = false) {
    if (isSplit) {
        // Bei Split bleiben wir bei der aktuellen Index-Position, um die erste neue Hand zu spielen
        // Außer bei Assen, dann geht's weiter.
    } else {
        currentHandIndex++;
    }

    while (currentHandIndex < playerHands.length && playerHands[currentHandIndex].status !== 'playing') {
        currentHandIndex++; // Springe zu 'playing' Hand
    }

    if (currentHandIndex < playerHands.length) {
        // Nächste Hand spielen
        updateGameOutput(`--- Nächste Hand: Hand ${currentHandIndex + 1} ---`);
        renderHands();
        enableActions(true);
    } else {
        // Alle Spielerhände fertig
        enableActions(false);
        document.getElementById('continue-btn').style.display = 'block';
        updateGameOutput("Alle deine Hände sind gespielt. Dealer ist an der Reihe.");
    }
}


// --- DEALER LOGIK UND AUSWERTUNG ---

function endTurn() {
    enableActions(false);
    document.getElementById('continue-btn').style.display = 'none';

    // 1. Dealer spielt
    let dealerValue = calculateHandValue(dealerHand);
    let minDealerValue = dealerRisk ? 16 : 17; // Händler-Provokation ändert die Regel

    updateGameOutput(`\n--- Dealer spielt (Minimum: ${minDealerValue}) ---`);
    renderHands();

    // Remove one-time dealer-risk item
    if (dealerRisk && playerInventory.includes("Händler-Provokation")) {
        playerInventory.splice(playerInventory.indexOf("Händler-Provokation"), 1);
        renderStatus();
    }
    
    while (dealerValue < minDealerValue) {
        const newCard = drawCard();
        dealerHand.push(newCard);
        dealerValue = calculateHandValue(dealerHand);
        updateGameOutput(`Dealer zieht: [${newCard}]. Wert: ${dealerValue}`);
        renderHands(); // Update nach jedem Zug
    }

    if (dealerValue > 21) {
        updateGameOutput("Dealer Bust! Alle verbleibenden Spielerhände gewinnen.");
    } else {
        updateGameOutput(`Dealer bleibt bei ${dealerValue}.`);
    }
    
    // 2. Auswertung
    updateGameOutput("\n--- Auswertung aller Hände ---");
    
    let totalWin = 0;
    
    playerHands.forEach((hand, index) => {
        const playerValue = calculateHandValue(hand.cards);
        let message = `Hand ${index + 1} (Wert: ${playerValue}, Wette: ${hand.bet}): `;
        
        if (playerValue > 21) {
            message += "Verloren (Bust).";
            totalWin -= hand.bet;
        } else if (dealerValue > 21 || playerValue > dealerValue) {
            let winAmount = hand.bet;
            
            // Blackjack Auszahlung (falls 2 Karten und 21, und Dealer kein Blackjack hat)
            if (playerValue === 21 && hand.cards.length === 2 && dealerValue !== 21) {
                const bjMultiplier = playerInventory.includes("Glücks-Multiplikator") ? 2 : 1.5;
                winAmount = hand.bet * bjMultiplier;
                message += `🎉 Blackjack! Gewinn (${bjMultiplier}:1): ${winAmount} Gold.`;
            } else {
                message += `Gewonnen! Gewinn (1:1): ${winAmount} Gold.`;
            }
            totalWin += winAmount;
        } else if (playerValue === dealerValue) {
            message += "Unentschieden (Push). Einsatz zurück.";
            playerGold += hand.bet; // Einsatz zurückgeben
        } else {
            message += "Verloren.";
            totalWin -= hand.bet;
        }
        updateGameOutput(message);
    });

    // 3. Gold aktualisieren
    playerGold += totalWin;

    // 4. HP-Regelung
    if (playerGold <= 0) {
        playerHP -= 1;
        updateGameOutput(`\n⚠️ Du hast dein Gold verloren und verlierst 1 HP. Aktuelle HP: ${playerHP}`);
        
        // Amulett der Erlösung prüfen
        if (playerHP <= 0 && playerInventory.includes("Amulett der Erlösung")) {
            playerHP = 1;
            playerInventory.splice(playerInventory.indexOf("Amulett der Erlösung"), 1);
            updateGameOutput("✨ Amulett der Erlösung aktiviert! Dein Tod wurde verhindert. Das Amulett ist nun verbraucht.");
        }
        
        // Neues Startgold
        if (playerGold <= 0 && playerHP > 0) {
            playerGold = 50;
            updateGameOutput("Neues Startkapital von 50 Gold erhalten.");
        }
    }
    
    if (playerHP <= 0) {
        document.getElementById('game-area').style.display='none';
        alert(`--- GAME OVER --- Dein Abenteuer endet hier. Letztes Gold: ${playerGold}`);
        showMainMenu();
    } else {
        // Zurück zum Spiel-Setup
        setTimeout(startGame, 5000); 
    }
    renderStatus();
}

// --- SHOP LOGIK ---

function showShop() {
    document.getElementById('main-menu').style.display = 'none';
    document.getElementById('game-setup').style.display = 'none';
    document.getElementById('game-area').style.display = 'none';
    document.getElementById('shop-area').style.display = 'block';
    renderShop();
}

function renderShop() {
    let shopHTML = '';
    const shopList = document.getElementById('shop-list');
    let itemIndex = 1;

    for (const name in SHOP_GEGENSTAENDE) {
        const details = SHOP_GEGENSTAENDE[name];
        const rarity = details.seltenheit;
        const colorClass = SELTENHEITEN[rarity].klasse;
        const isDisabled = playerGold < details.kosten;

        // Prüfen, ob passiver Gegenstand bereits im Inventar ist
        const isPassiveOwned = ["Glücks-Multiplikator", "Amulett der Erlösung"].includes(name) && playerInventory.includes(name);
        
        const buyButton = isPassiveOwned 
            ? `<button disabled>✅ BESITZT</button>`
            : `<button onclick="buyItem('${name}', ${details.kosten})" ${isDisabled ? 'disabled' : ''}>Kaufen</button>`;

        shopHTML += `
            <li style="margin-bottom: 10px; border-bottom: 1px dotted #444; padding-bottom: 5px;">
                <span class="${colorClass}">[${rarity}]</span> <strong>${name}</strong> - ${details.kosten} Gold
                <br><em>Effekt: ${details.effekt}</em>
                ${buyButton}
            </li>
        `;
        itemIndex++;
    }
    shopList.innerHTML = shopHTML;
    renderStatus();
}

function buyItem(itemName, cost) {
    if (playerGold < cost) {
        alert("Nicht genug Gold!");
        return;
    }

    playerGold -= cost;

    if (itemName.includes("Skin")) {
        currentSkin = itemName.split('(')[1].replace(')', '');
        alert(`Du hast den Skin '${currentSkin}' gekauft und ausgerüstet!`);
    } else {
        if (playerInventory.includes(itemName) && ["Glücks-Multiplikator", "Amulett der Erlösung"].includes(itemName)) {
            alert("Du besitzt diesen passiven Gegenstand bereits!");
            playerGold += cost; // Gold zurückgeben, falls Fehler
            return;
        }
        playerInventory.push(itemName);
        alert(`Du hast '${itemName}' gekauft!`);
    }

    renderShop();
    renderStatus();
}

// --- INITIALISIERUNG ---
window.onload = () => {
    showMainMenu();
};
</script>

</body>
</html>