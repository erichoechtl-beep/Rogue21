<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rogue 21</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* WICHTIG: Stellt sicher, dass die App den gesamten Bildschirm einnimmt */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            min-height: 100vh;
            overflow: hidden; 
            box-sizing: border-box;
        }

        body {
            display: flex;
            flex-direction: column;
            font-family: ui-sans-serif, system-ui, sans-serif;
            
            /* NEU: Pokertisch Hintergrund */
            background-color: #0b5302; 
            background-image: radial-gradient(#117006 10%, #0b5302 60%);
            background-attachment: fixed;
        }
        
        /* Haupt-Container-Layout */
        #app-container {
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%; 
            padding: 1rem;
            max-width: 900px;
            margin: 0 auto;
        }
        
        /* Allgemeine UI-Klassen */
        .smooth-panel {
            background-color: rgba(31, 41, 55, 0.9); /* Leicht transparent */
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            border: 1px solid #4b5563;
        }
        .smooth-btn {
            border-radius: 6px;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.1s; /* Verbesserte Transition */
        }
        .smooth-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5); /* Sch√§rferer Schatten beim Hover */
        }
        /* NEU: Verbesserte Animation beim Klicken */
        .smooth-btn:active:not(:disabled) {
            transform: translateY(1px);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }
        .smooth-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        /* --- SHOP SELTENHEITEN F√úR RANDFARBEN --- */
        .rarity-common { border-color: #10b981; } /* Gr√ºn */
        .rarity-uncommon { border-color: #3b82f6; } /* Blau */
        .rarity-rare { border-color: #f59e0b; } /* Gelb */
        .rarity-epic { border-color: #9333ea; } /* Lila */
        .rarity-legendary { border-color: #f97316; } /* Orange */

        /* --- KARTEN STYLING & ANIMATIONEN --- */
        .card {
            background-color: white;
            color: black;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 75px;
            height: 110px;
            display: inline-flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0 4px 8px 4px;
            position: relative;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
            font-weight: bold;
            vertical-align: top;
            
            opacity: 1;
            transform: none;
            transition: transform 0.4s ease-out;
        }

        .suit-red { color: #dc2626; }
        .suit-black { color: #1f2937; }

        .card-back {
            background-color: #4f46e5;
            color: white;
            border-color: #6366f1;
            font-size: 20px;
            font-family: monospace;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* Definiert die Skins */
        .skin-default { background-color: #4f46e5 !important; border-color: #6366f1 !important; }
        .skin-gold { background-color: #f59e0b !important; border-color: #fbbf24 !important; }
        .skin-cyber { background-color: #111827 !important; border-color: #3b82f6 !important; color: #a5f3fc !important; }
        .skin-crimson { background-color: #991b1b !important; border-color: #ef4444 !important; }
        .skin-matrix { background-color: #0d120a !important; border-color: #4ade80 !important; color: #4ade80 !important; font-family: monospace !important; }
        .skin-balatro { background-image: linear-gradient(135deg, #a78bfa, #8b5cf6) !important; border-color: #c4b5fd !important; }

        /* NEUE: Animation f√ºr das Ziehen einer neuen Karte */
        .new-card-animation {
            animation: flyIn 0.3s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
            opacity: 0;
        }

        @keyframes flyIn {
            0% { 
                transform: translateY(-50px) scale(0.8) rotateZ(5deg); 
                opacity: 0; 
            }
            100% { 
                transform: translateY(0) scale(1) rotateZ(0); 
                opacity: 1; 
            }
        }
        
        /* KORRIGIERT: Blackjack T√§nzchen Animation */
        .blackjack-dance {
            animation: jiggle 0.3s infinite alternate;
        }

        @keyframes jiggle {
            0% { transform: rotate(0deg); box-shadow: 0 0 15px 5px rgba(255, 255, 0, 0.8); }
            50% { transform: rotate(2deg) translateY(-3px); }
            100% { transform: rotate(-2deg) translateY(3px); box-shadow: 0 0 15px 5px rgba(255, 165, 0, 0.8); }
        }

        /* Notification Box */
        #notification-box {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            padding: 10px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            transition: transform 0.5s ease-out, opacity 0.5s;
            opacity: 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }
        #notification-box.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        /* Tooltip Style (f√ºr Ph√∂nix Amulett) */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }
        .tooltip {
            visibility: hidden;
            width: 250px;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* Platzierung oben */
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            border: 1px solid #9333ea;
        }
        .tooltip-container:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #9333ea transparent transparent transparent;
        }
    </style>
</head>
<body class="text-white">
    <div id="app-container" class="space-y-4">

        <div class="flex justify-between items-center smooth-panel p-3">
            <div class="flex items-center space-x-4">
                <span id="player-health" class="text-red-400 font-black text-xl">100/100 ‚ù§Ô∏è</span>
                <span id="player-gold" class="text-yellow-400 font-black text-xl">0 üí∞</span>
            </div>
            
            <div class="flex items-center space-x-4">
                <span id="current-floor" class="text-lg font-black bg-blue-700 py-1 px-3 rounded-full shadow-lg">Level 1</span>
                <div id="reroll-charges-display" class="flex items-center space-x-1 text-blue-400 font-black text-xl bg-gray-700 py-1 px-3 rounded-full shadow-lg">
                    <span class="text-2xl">üé≤</span>
                    <span id="reroll-count">0</span>
                </div>
            </div>
        </div>
        
        <div id="boss-status-bar" class="smooth-panel p-3 bg-red-800/50 border-red-500 hidden">
            <p class="font-bold text-center mb-1">BOSS HEALTH</p>
            <div class="relative pt-1">
                <div class="overflow-hidden h-4 mb-4 text-xs flex rounded bg-red-200">
                    <div id="boss-health-bar" style="width: 100%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-red-500 transition-all duration-300 ease-out"></div>
                </div>
                <div id="boss-health" class="absolute top-0 left-0 right-0 text-center font-black text-xs text-white"></div>
            </div>
        </div>

        <div id="notification-box" class="hidden"></div>
        
        <div id="main-menu" class="flex-grow flex flex-col justify-center items-center space-y-6">
            <h1 class="text-6xl font-black text-yellow-400 drop-shadow-lg">Rogue 21</h1>
            
            <button onclick="startNewRun()" class="smooth-btn bg-green-600 hover:bg-green-700 text-white w-64 py-4 text-xl">Neuer Run</button>
            <button onclick="showCosmeticsShop()" class="smooth-btn bg-purple-600 hover:bg-purple-700 text-white w-64 py-4 text-xl">Skins & Punkte (<span id="total-points">0</span> ‚≠ê)</button>
            <button onclick="showHighscores()" class="smooth-btn bg-blue-600 hover:bg-blue-700 text-white w-64 py-4 text-xl">Highscores</button>
            <button onclick="showAchievements()" class="smooth-btn bg-gray-600 hover:bg-gray-700 text-white w-64 py-4 text-xl">Achievements</button>
        </div>

        <div id="gameplay-state" class="flex-grow flex flex-col justify-between hidden">
            <div class="smooth-panel p-3 mb-2">
                <h3 id="dealer-title" class="text-lg font-bold text-center mb-2">Dealer's Hand</h3>
                <div id="dealer-hand" class="flex justify-center flex-wrap">
                    </div>
            </div>
            
            <div id="message-box" class="text-center font-black text-2xl py-3 rounded-lg my-4 transition-colors duration-300 bg-gray-800/50">Mach deinen Zug!</div>

            <div class="smooth-panel p-3 mt-2">
                <h3 class="text-lg font-bold text-center mb-2">Deine Hand (<span id="player-score">0</span>)</h3>
                <div id="player-hand" class="flex justify-center flex-wrap">
                    </div>
            </div>

            <div class="flex justify-center space-x-2 pt-4 pb-2">
                <button id="btn-hit" onclick="hit()" class="smooth-btn bg-green-500 hover:bg-green-600 w-32 py-3 text-lg">Hit</button>
                <button id="btn-stand" onclick="stand()" class="smooth-btn bg-red-500 hover:bg-red-600 w-32 py-3 text-lg">Stand</button>
                <button id="btn-double" onclick="doubleDown()" class="smooth-btn bg-yellow-500 hover:bg-yellow-600 w-32 py-3 text-sm">Double (<span id="double-tooltip">Verdoppelt Goldgewinn</span>)</button>
                <button id="btn-split" onclick="splitHand()" class="smooth-btn bg-blue-500 hover:bg-blue-600 w-32 py-3 text-lg hidden" disabled>Split</button>
            </div>
            
            <div class="flex justify-center pt-2">
                <button id="btn-use-preview" onclick="showPreviewUI()" class="smooth-btn bg-yellow-700 hover:bg-yellow-600 text-white py-2 px-4 text-sm hidden">
                    Seherblick (<span id="preview-charge-count">0</span>)
                </button>
            </div>
            
            <div id="preview-card-box" class="smooth-panel p-2 flex justify-between items-center mt-2 hidden">
                <span class="font-bold text-gray-300 flex items-center">
                    N√§chste Karte: 
                    <span id="preview-card-placeholder" class="ml-2">...</span>
                </span>
                <div class="space-x-2">
                    <button id="btn-accept-preview" onclick="acceptPreviewCard()" class="smooth-btn bg-green-600 hover:bg-green-700 text-white py-1 px-3 text-sm">Nehmen</button>
                    <button id="btn-reject-preview" onclick="rejectPreviewCard()" class="smooth-btn bg-red-600 hover:bg-red-700 text-white py-1 px-3 text-sm">Ablehnen</button>
                </div>
            </div>

        </div>

        <div id="shop-container" class="flex-grow flex flex-col justify-center hidden">
            <div class="smooth-panel p-6 space-y-4">
                <h2 class="text-3xl font-black text-center text-yellow-400 mb-4">Shop</h2>
                <div class="flex justify-between items-center text-xl font-bold p-2 bg-gray-800 rounded">
                    <span>Dein Gold:</span>
                    <span id="shop-gold-display" class="text-yellow-400">0 üí∞</span>
                    <button onclick="rerollShopItems()" 
                            class="smooth-btn bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 text-sm">
                        Neu W√ºrfeln (10 üí∞)
                    </button>
                </div>
                
                <h3 class="text-xl font-bold text-gray-300 pt-2 border-t border-gray-600">Items (W√§hle 3, mit Seltenheit)</h3>
                <div id="shop-items" class="space-y-3">
                    </div>

                <div class="pt-4 flex justify-between space-x-4">
                    <button onclick="exitShop()" class="smooth-btn bg-green-600 hover:bg-green-700 text-white flex-grow py-3 text-lg">Weiter zu Level <span id="next-level-display"></span></button>
                    <button onclick="backToMenuFromShop()" class="smooth-btn bg-gray-600 hover:bg-gray-700 text-white py-3 px-6 text-lg">Aufgeben</button>
                </div>
            </div>
        </div>

        <div id="cosmetics-shop" class="flex-grow flex flex-col justify-center hidden">
            <div class="smooth-panel p-6 space-y-4">
                <h2 class="text-3xl font-black text-center text-purple-400 mb-4">Cosmetics Shop</h2>
                <div class="flex justify-between items-center text-xl font-bold p-2 bg-gray-800 rounded">
                    <span>Deine Punkte:</span>
                    <span id="cosmetics-points-display" class="text-purple-400">0 ‚≠ê</span>
                </div>
                
                <h3 class="text-xl font-bold text-gray-300 pt-2 border-t border-gray-600">Kartenr√ºcken</h3>
                <div id="card-back-shop-items" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    </div>
                
                <button onclick="ui.changeState('MENU')" class="smooth-btn bg-gray-600 hover:bg-gray-700 text-white w-full py-3 text-lg mt-4">Zur√ºck zum Men√º</button>
            </div>
        </div>
        
        <div id="game-over-overlay" class="absolute inset-0 bg-black/90 flex flex-col justify-center items-center z-50 hidden">
            <h1 class="text-6xl font-black text-red-500 mb-6 drop-shadow-xl">GAME OVER</h1>
            <p class="text-xl text-white mb-2">Du hast es bis Level <span id="final-floor" class="text-yellow-400 font-bold">1</span> geschafft.</p>
            <p class="text-xl text-white mb-8">Gesammeltes Gold: <span id="final-gold" class="text-yellow-400 font-bold">0</span> üí∞</p>
            <button onclick="resetGame()" class="smooth-btn bg-green-600 hover:bg-green-700 text-white w-64 py-4 text-xl">Neuer Versuch</button>
        </div>

        <div id="info-modal-overlay" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
            <div class="smooth-panel p-6 w-11/12 max-w-md">
                <h2 id="modal-title" class="text-2xl font-black text-center mb-4 text-blue-400">Titel</h2>
                <div id="modal-content" class="text-white space-y-3 max-h-96 overflow-y-auto pr-2">
                    </div>
                <button onclick="closeModal()" class="smooth-btn bg-gray-600 hover:bg-gray-700 text-white w-full py-2 mt-6">Schlie√üen</button>
            </div>
        </div>

    </div>
    <script type="module">
        // --- GAME STATES UND MANAGER ---
        const GAME_STATE = {
            MENU: 'MENU',
            PLAYING: 'PLAYING',
            SHOP: 'SHOP',
            COSMETICS: 'COSMETICS',
            GAMEOVER: 'GAMEOVER'
        };
        
        const GAME_MODE = {
            STANDARD: 'STANDARD',
            BOSS: 'BOSS'
        };

        let currentState = GAME_STATE.MENU;
        let deck = [];
        let playerHand = [];
        let dealerHand = [];
        let isGameActive = false;
        let turnCount = 0;

        // Roguelike Status
        let playerHealth = 100;
        let maxHealth = 100;
        let playerGold = 0;
        let currentLevel = 1;
        
        // Modifikatoren
        let goldMultiplier = 1;
        let rerollCharges = 0; 
        let doubleDownUsed = false;
        let blackjackMultiplier = 1; 
        let hasExtraLife = false; 
        let dealerRiskLevel = 0; 
        let previewCharges = 0; // NEU: Seherblick Charges

        // BOSS Status
        let gameMode = GAME_MODE.STANDARD;
        let bossHealth = 0;
        let bossMaxHealth = 0;
        
        // Preview Karte
        let previewCard = null; // Speichert die Karte, die der Spieler sehen kann
        let isPreviewing = false; // Zustand, ob die Preview-Box offen ist

        // Cosmetics/Progression
        let totalPoints = parseInt(localStorage.getItem('totalPoints') || '0', 10);
        let highscores = JSON.parse(localStorage.getItem('blackjackHighscores') || '[]');
        let unlockedSkins = JSON.parse(localStorage.getItem('unlockedSkins') || '["default"]');
        let equippedSkin = localStorage.getItem('equippedSkin') || 'default';
        
        // Konstanten
        const SUITS = ['‚ô•', '‚ô¶', '‚ô£', '‚ô†'];
        const VALUES = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];

        const ACHIEVEMENTS = [
            { id: 'first_win', name: 'Erster Sieg', condition: () => currentLevel >= 2, points: 10, unlocked: false },
            { id: 'level_5', name: 'Wegbereiter (Level 5)', condition: () => currentLevel >= 5, points: 50, unlocked: false },
            { id: '100_gold', name: 'Reichtum', condition: () => playerGold >= 100, points: 20, unlocked: false },
            { id: 'first_boss_kill', name: 'Erster Bosskill', condition: () => currentLevel > 10, points: 100, unlocked: false }
        ];
        
        // NEU: Seltenheiten Definition
        const RARITY = {
            COMMON: { name: 'Gew√∂hnlich', color: 'text-green-400', css: 'rarity-common', chance: 50 },
            UNCOMMON: { name: 'Ungew√∂hnlich', color: 'text-blue-400', css: 'rarity-uncommon', chance: 30 },
            RARE: { name: 'Selten', color: 'text-yellow-400', css: 'rarity-rare', chance: 15 },
            EPIC: { name: 'Episch', color: 'text-purple-400', css: 'rarity-epic', chance: 4.5 },
            LEGENDARY: { name: 'Legend√§r', color: 'text-orange-400', css: 'rarity-legendary', chance: 0.5 }
        };

        // KORRIGIERT UND ERWEITERT: Shop Items mit Seltenheit und neuer Logik
        const SHOP_ITEMS_POOL = [
            // Gew√∂hnlich (COMMON)
            { id: 'max_hp_boost', name: '+10 Max Health', cost: 30, rarity: RARITY.COMMON, effect: () => { maxHealth += 10; playerHealth += 10; ui.updateStatus(); showNotification("Max Health erh√∂ht.", 'bg-green-500'); } }, 
            { id: 'heal_15', name: 'Heilung (15 HP)', cost: 20, rarity: RARITY.COMMON, effect: () => { playerHealth = Math.min(maxHealth, playerHealth + 15); ui.updateStatus(); showNotification("Du wurdest geheilt.", 'bg-green-500'); } },
            
            // Ungew√∂hnlich (UNCOMMON)
            { id: 'extra_life_small', name: 'Robuste Haut (+20 HP)', cost: 80, rarity: RARITY.UNCOMMON, effect: () => { maxHealth += 20; playerHealth += 20; ui.updateStatus(); showNotification("Du f√ºhlst dich robuster.", 'bg-blue-500'); } }, 
            { id: 'add_reroll_charge', name: 'W√ºrfel-Charge (+1)', cost: 25, rarity: RARITY.UNCOMMON, effect: () => { rerollCharges += 1; ui.showMessage(`Du hast 1 Charge zum W√ºrfeln erhalten. Aktuell: ${rerollCharges}`, false); showNotification(`+1 W√ºrfel-Charge.`, 'bg-blue-500'); } }, 
            { id: 'damage_reduction', name: 'Schadensresistenz', cost: 70, rarity: RARITY.UNCOMMON, effect: () => { playerHealth += 5; ui.updateStatus(); showNotification("Schadensresistenz erworben.", 'bg-blue-500'); } },

            // Selten (RARE)
            { id: 'preview_card', name: 'Seherblick Charge (+1)', cost: 50, rarity: RARITY.RARE, effect: () => { 
                previewCharges += 1;
                ui.updateStatus();
                showNotification("Seherblick Charge erhalten!", 'bg-yellow-600'); 
            }, available: () => true, isConsumable: true }, // Charge kaufen
            { id: 'blackjack_multiplier_rare', name: 'Gl√ºcks-Multiplikator (x1.5)', cost: 120, rarity: RARITY.RARE, effect: () => { 
                blackjackMultiplier = 1.5; 
                showNotification("Blackjack Auszahlung x1.5!", 'bg-yellow-600'); 
            }, available: () => blackjackMultiplier === 1 },
            
            // Episch (EPIC)
            { id: 'extra_life_epic', name: 'Ph√∂nix-Amulett', cost: 200, rarity: RARITY.EPIC, effect: () => { 
                hasExtraLife = true; 
                showNotification("Ph√∂nix-Amulett aktiviert. Einmaliger Todesschutz!", 'bg-purple-600'); 
            }, available: () => !hasExtraLife },

            // Legend√§r (LEGENDARY)
            { id: 'dealer_risk', name: 'Risikobereiter Dealer', cost: 400, rarity: RARITY.LEGENDARY, effect: () => { 
                dealerRiskLevel = 1; 
                showNotification("Dealer spielt jetzt risikofreudiger!", 'bg-orange-600'); 
            }, available: () => dealerRiskLevel === 0 },
            { id: 'gold_double', name: 'Gold-Multiplikator (x2)', cost: 300, rarity: RARITY.LEGENDARY, effect: () => { 
                goldMultiplier = 2; 
                ui.showMessage('Gold wird ab jetzt verdoppelt! (Passiv)', false); 
                showNotification('Gold x2 freigeschaltet!', 'bg-orange-600'); 
            }, available: () => goldMultiplier === 1 }, 
        ];
        let currentShopItems = []; 

        // NEU: Popkultur Skins hinzugef√ºgt
        const CARD_BACK_SKINS = [
            { id: 'default', name: 'Standard (Lila)', cost: 0, cssClass: 'skin-default' },
            { id: 'gold', name: 'Gold Rush', cost: 100, cssClass: 'skin-gold' },
            { id: 'matrix', name: 'The Matrix (Code)', cost: 200, cssClass: 'skin-matrix' }, 
            { id: 'balatro', name: 'Balatro Style', cost: 300, cssClass: 'skin-balatro' }, 
            { id: 'cyber', name: 'Cyber Grid', cost: 250, cssClass: 'skin-cyber' },
            { id: 'crimson', name: 'Crimson Edge', cost: 500, cssClass: 'skin-crimson' }
        ];

        // --- HILFSFUNKTIONEN ---

        /** Erstellt und mischt ein neues Deck. */
        function createDeck() {
            // ... (Funktion bleibt gleich)
            const newDeck = [];
            for (const suit of SUITS) {
                for (const value of VALUES) {
                    newDeck.push({ suit, value });
                }
            }
            // Fisher-Yates Shuffle
            for (let i = newDeck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newDeck[i], newDeck[j]] = [newDeck[j], newDeck[i]];
            }
            return newDeck;
        }

        /** Berechnet den bestm√∂glichen Blackjack-Score f√ºr eine Hand. */
        function getScore(hand) {
            let score = 0;
            let numAces = 0;
            for (const card of hand) {
                if (card.value === 'A') {
                    numAces++;
                    score += 11;
                } else if (['K', 'Q', 'J', '10'].includes(card.value)) {
                    score += 10;
                } else {
                    score += parseInt(card.value);
                }
            }
            while (score > 21 && numAces > 0) {
                score -= 10;
                numAces--;
            }
            return score;
        }

        /** Zeichnet eine Karte vom Deck. */
        function drawCard() {
            if (deck.length === 0) deck = createDeck();
            return deck.pop();
        }

        /** Erstellt das HTML-Element f√ºr eine Karte. */
        function createCardElement(card, isHidden = false, index = -1, isNewCard = false) {
            const suitClass = (card.suit === '‚ô•' || card.suit === '‚ô¶') ? 'suit-red' : 'suit-black';
            const cardBackSkin = CARD_BACK_SKINS.find(s => s.id === equippedSkin) || CARD_BACK_SKINS[0];
            
            const content = isHidden 
                ? `<div class="font-black">R21</div>` 
                : `<div class="text-3xl">${card.suit}</div><div class="text-xl">${card.value}</div>`;
                
            const hiddenClass = isHidden 
                ? `card-back ${cardBackSkin.cssClass}` 
                : 'bg-white';
            
            const animationClass = isNewCard ? 'new-card-animation' : '';
            
            const rerollButton = (rerollCharges > 0 && !isHidden && index !== -1) ? 
                `<button onclick="rerollCard(${index})" class="text-xs absolute bottom-0 right-0 bg-blue-500 hover:bg-blue-600 text-white p-1 rounded-br-md rounded-tl-md font-bold">R</button>` : '';

            return `
                <div class="card ${suitClass} ${hiddenClass} ${animationClass}" data-card-index="${index}">
                    ${content}
                    ${rerollButton}
                </div>
            `;
        }
        
        /** Benachrichtigung anzeigen */
        let notificationTimeout;
        function showNotification(message, bgColorClass = 'bg-blue-600', duration = 3000) {
            const el = document.getElementById('notification-box');
            el.innerHTML = message;
            el.className = bgColorClass + ' show';
            el.classList.remove('hidden');

            clearTimeout(notificationTimeout);
            notificationTimeout = setTimeout(() => {
                el.classList.remove('show');
                setTimeout(() => el.classList.add('hidden'), 500);
            }, duration);
        }

        /** Spieler kann eine Karte neu ziehen (kostet eine Charge). */
        window.rerollCard = function(index) {
            if (!isGameActive || rerollCharges <= 0 || index < 0 || index >= playerHand.length) return;
            
            rerollCharges -= 1;
            playerHand.splice(index, 1, drawCard());
            
            ui.updateHands(false);
            ui.showMessage(`Karte neu gew√ºrfelt! (${rerollCharges} Charges √ºbrig)`, false);
            ui.updateStatus();
            
            const playerScore = getScore(playerHand);
            if (playerScore > 21) {
                endGame("Bust nach dem W√ºrfeln!", false);
            } else if (playerScore === 21) {
                stand();
            }
        }
        
        /** Speichert Highscore und Punkte */
        function saveHighscore() {
            // ... (Funktion bleibt gleich)
            const newScore = {
                floor: currentLevel,
                gold: playerGold,
                date: new Date().toISOString().slice(0, 10)
            };
            highscores.push(newScore);
            highscores.sort((a, b) => b.floor - a.floor || b.gold - a.gold);
            
            highscores = highscores.slice(0, 10); 
            
            localStorage.setItem('blackjackHighscores', JSON.stringify(highscores));
            localStorage.setItem('totalPoints', totalPoints.toString());
            
            checkAchievements();
        }

        /** Achievement-Pr√ºfung */
        function checkAchievements() {
            // ... (Funktion bleibt gleich)
            let pointsGained = 0;
            const achievementsStatus = JSON.parse(localStorage.getItem('achievements') || '[]');
            
            ACHIEVEMENTS.forEach(a => {
                const storedA = achievementsStatus.find(sa => sa.id === a.id) || a;

                if (!storedA.unlocked && a.condition()) {
                    storedA.unlocked = true;
                    totalPoints += a.points;
                    pointsGained += a.points;
                    showNotification(`ACHIEVEMENT: ${a.name} freigeschaltet! (+${a.points} ‚≠ê)`, 'bg-yellow-600', 5000);
                }
            });
            
            const updatedAchievements = ACHIEVEMENTS.map(a => {
                const storedA = achievementsStatus.find(sa => sa.id === a.id);
                return storedA ? storedA : a;
            });

            if (pointsGained > 0) {
                localStorage.setItem('totalPoints', totalPoints.toString());
            }
            localStorage.setItem('achievements', JSON.stringify(updatedAchievements));
        }

        // --- UI Controller ---

        const ui = {
            // Element IDs
            dealerHandEl: document.getElementById('dealer-hand'),
            playerHandEl: document.getElementById('player-hand'),
            playerScoreEl: document.getElementById('player-score'),
            playerHealthEl: document.getElementById('player-health'),
            playerGoldEl: document.getElementById('player-gold'),
            currentLevelEl: document.getElementById('current-floor'),
            rerollCountEl: document.getElementById('reroll-count'), 
            messageBoxEl: document.getElementById('message-box'),
            btnHit: document.getElementById('btn-hit'),
            btnStand: document.getElementById('btn-stand'),
            btnDouble: document.getElementById('btn-double'),
            btnSplit: document.getElementById('btn-split'),
            dealerTitleEl: document.getElementById('dealer-title'),
            gameOverOverlay: document.getElementById('game-over-overlay'),
            bossStatusBarEl: document.getElementById('boss-status-bar'),
            bossHealthEl: document.getElementById('boss-health'),
            bossHealthBarEl: document.getElementById('boss-health-bar'),
            previewCardBoxEl: document.getElementById('preview-card-box'), 
            previewCardPlaceholderEl: document.getElementById('preview-card-placeholder'), 
            btnUsePreviewEl: document.getElementById('btn-use-preview'), // NEU
            previewChargeCountEl: document.getElementById('preview-charge-count'), // NEU


            mainMenuEl: document.getElementById('main-menu'),
            shopContainerEl: document.getElementById('shop-container'),
            gameplayStateEl: document.getElementById('gameplay-state'),
            cosmeticsShopEl: document.getElementById('cosmetics-shop'),
            shopGoldDisplayEl: document.getElementById('shop-gold-display'),
            cosmeticsPointsDisplayEl: document.getElementById('cosmetics-points-display'),
            shopItemsEl: document.getElementById('shop-items'),
            infoModalOverlay: document.getElementById('info-modal-overlay'),
            modalTitleEl: document.getElementById('modal-title'),
            modalContentEl: document.getElementById('modal-content'),
            totalPointsEl: document.getElementById('total-points'),
            nextLevelDisplayEl: document.getElementById('next-level-display'),


            // Methoden
            
            /** Aktualisiert die Karten-HTML beider H√§nde. */
            updateHands(revealDealer = false) {
                this.dealerHandEl.innerHTML = dealerHand.map((card, index) =>
                    createCardElement(card, !revealDealer && index === 0)
                ).join('');

                this.playerHandEl.innerHTML = playerHand.map((card, index) => createCardElement(card, false, index)).join('');

                this.updateScoreAndControls(revealDealer);
            },
            
            /** F√ºgt EINE einzelne Karte mit Animation hinzu und aktualisiert sofort den Score. */
            addCardToHand(hand, card, isDealer = false) {
                hand.push(card);
                
                const containerEl = isDealer ? this.dealerHandEl : this.playerHandEl;
                const index = hand.length - 1;
                
                const cardHTML = createCardElement(card, isDealer && hand.length === 2, isDealer ? -1 : index, true);
                containerEl.insertAdjacentHTML('beforeend', cardHTML);

                this.updateScoreAndControls();
            },

            /** Aktualisiert Score, Dealer-Titel und Kontrollen. */
            updateScoreAndControls(revealDealer = false) {
                const playerScore = getScore(playerHand);
                this.playerScoreEl.textContent = playerScore;

                if (revealDealer) {
                    this.dealerTitleEl.textContent = `Dealer's Hand (${getScore(dealerHand)})`;
                } else {
                    this.dealerTitleEl.textContent = "Dealer's Hand";
                }
                
                // Kontrollen nach Zug aktualisieren
                // KORRIGIERT: Double Down ist nur im ersten Zug und nur einmal pro Runde m√∂glich
                this.btnDouble.disabled = turnCount !== 0 || doubleDownUsed || playerScore > 21; 
                this.btnSplit.classList.toggle('hidden', turnCount !== 0 || playerHand.length !== 2 || playerHand[0].value !== playerHand[1].value);
                
                // NEU: Double Button Tooltip
                document.getElementById('double-tooltip').textContent = doubleDownUsed ? 'Verbraucht' : 'Verdoppelt Goldgewinn';
                
                // NEU: Seherblick Button
                this.btnUsePreviewEl.classList.toggle('hidden', previewCharges === 0 || isPreviewing);
                this.previewChargeCountEl.textContent = previewCharges;


                if (playerScore > 21) {
                    this.setControls(false);
                }
                
                // Wenn im Preview-Zustand, Haupt-Controls sperren
                if (isPreviewing) {
                    this.setControls(false);
                } else if (isGameActive) {
                    this.setControls(true);
                }
            },


            updateStatus() {
                // NEU: Ph√∂nix Amulett Tooltip Hinzugef√ºgt
                let healthText = `${playerHealth}/${maxHealth} ‚ù§Ô∏è`;
                if (hasExtraLife) {
                    healthText = `
                        <div class="tooltip-container">
                            <span class="text-red-400 font-black text-xl">${playerHealth}/${maxHealth} ‚ù§Ô∏è (‚≠ê)</span>
                            <span class="tooltip text-sm">Ph√∂nix-Amulett aktiv: Verhindert einmal den Tod!</span>
                        </div>
                    `;
                } else {
                     healthText = `<span class="text-red-400 font-black text-xl">${playerHealth}/${maxHealth} ‚ù§Ô∏è</span>`;
                }
                this.playerHealthEl.innerHTML = healthText;


                this.playerGoldEl.textContent = `${playerGold} üí∞`;
                this.currentLevelEl.textContent = `Level ${currentLevel}`; 
                this.totalPointsEl.textContent = totalPoints;
                this.shopGoldDisplayEl.textContent = playerGold;
                this.cosmeticsPointsDisplayEl.textContent = totalPoints;
                this.rerollCountEl.textContent = rerollCharges; 
                this.nextLevelDisplayEl.textContent = currentLevel + 1;
                this.previewChargeCountEl.textContent = previewCharges;
                
                if (gameMode === GAME_MODE.BOSS) {
                    this.bossStatusBarEl.classList.remove('hidden');
                    this.bossHealthEl.textContent = `${bossHealth}/${bossMaxHealth}`;
                    const percent = (bossHealth / bossMaxHealth) * 100;
                    this.bossHealthBarEl.style.width = `${percent}%`;
                } else {
                    this.bossStatusBarEl.classList.add('hidden');
                }
            },

            showMessage(message, isEndState = false) {
                this.messageBoxEl.innerHTML = message;
                this.messageBoxEl.classList.remove('text-green-400', 'text-red-400', 'text-yellow-400');
                if (isEndState) {
                    // KORRIGIERT: Gewinnmeldungen jetzt mit dunklerem, auff√§lligerem Gr√ºn
                    if (message.includes('Gewonnen') || message.includes('BLACKJACK') || message.includes('BOSS besiegt')) {
                         this.messageBoxEl.classList.add('text-lime-300', 'bg-green-900/40');
                    } else {
                         this.messageBoxEl.classList.add('text-red-400', 'bg-black/40');
                    }
                } else {
                    this.messageBoxEl.classList.add('text-yellow-400');
                    this.messageBoxEl.classList.remove('bg-black/40', 'bg-green-900/40');
                }
            },

            setControls(active) {
                this.btnHit.disabled = !active;
                this.btnStand.disabled = !active;
                this.btnDouble.disabled = !active || turnCount !== 0 || doubleDownUsed || getScore(playerHand) > 21;
                this.btnSplit.disabled = !active || turnCount !== 0 || playerHand.length !== 2 || playerHand[0].value !== playerHand[1].value;
                
                // Seherblick Button wird nur gezeigt, wenn isPreviewing FALSE ist
                this.btnUsePreviewEl.disabled = !active || isPreviewing;
                this.btnUsePreviewEl.classList.toggle('hidden', previewCharges === 0);

                // Wenn im Preview-Zustand, Haupt-Controls sperren
                if (isPreviewing) {
                    this.btnHit.disabled = true;
                    this.btnStand.disabled = true;
                    this.btnDouble.disabled = true;
                }
            },
            
            showPreviewUI(card) {
                // Diese Funktion wird jetzt von showPreviewUI() in der Logik aufgerufen
                const cardEl = createCardElement(card, false, -1, false);
                this.previewCardPlaceholderEl.innerHTML = cardEl;
                this.previewCardBoxEl.classList.remove('hidden');
                this.setControls(false); // Haupt-Controls sperren
                isPreviewing = true;
                this.btnUsePreviewEl.classList.add('hidden'); // Verstecke den Seherblick Button
            },

            hidePreviewUI() {
                this.previewCardBoxEl.classList.add('hidden');
                this.previewCardPlaceholderEl.innerHTML = '...';
                isPreviewing = false;
                if (isGameActive) {
                    this.setControls(true);
                }
            },

            changeState(newState) {
                this.mainMenuEl.classList.add('hidden');
                this.gameplayStateEl.classList.add('hidden');
                this.shopContainerEl.classList.add('hidden');
                this.cosmeticsShopEl.classList.add('hidden');
                this.gameOverOverlay.classList.add('hidden');
                this.infoModalOverlay.classList.add('hidden');
                this.previewCardBoxEl.classList.add('hidden'); // Immer verstecken bei State-Wechsel
                
                // NEU: Seherblick Button muss bei State Wechsel auch versteckt werden
                this.btnUsePreviewEl.classList.add('hidden');
                isPreviewing = false;
                
                switch (newState) {
                    case GAME_STATE.MENU:
                        this.mainMenuEl.classList.remove('hidden');
                        break;
                    case GAME_STATE.PLAYING:
                        this.gameplayStateEl.classList.remove('hidden');
                        break;
                    case GAME_STATE.SHOP:
                        this.shopContainerEl.classList.remove('hidden');
                        break;
                    case GAME_STATE.COSMETICS:
                        this.cosmeticsShopEl.classList.remove('hidden');
                        break;
                    case GAME_STATE.GAMEOVER:
                        this.showGameOver();
                        break;
                }
                currentState = newState;
                this.updateStatus();
            },

            showGameOver() {
                document.getElementById('final-floor').textContent = currentLevel;
                document.getElementById('final-gold').textContent = playerGold;
                this.gameOverOverlay.classList.remove('hidden');
            },
        };

        // --- SHOP FUNKTIONEN ---
        
        /** NEU: Reroll Shop Items Funktion */
        window.rerollShopItems = function() {
            const REROLL_COST = 10;
            if (playerGold < REROLL_COST) {
                showNotification("Nicht genug Gold f√ºr Reroll (10 üí∞)!", 'bg-red-500');
                return;
            }
            playerGold -= REROLL_COST;
            showNotification("Shop neu ausgew√ºrfelt!", 'bg-blue-500');
            renderShop();
        }

        /** Item zuf√§llig basierend auf Wahrscheinlichkeit ausw√§hlen */
        function getRandomItemByRarity() {
            const availableItems = SHOP_ITEMS_POOL.filter(item => !item.available || item.available());
            
            let totalChance = 0;
            const itemsWithWeights = availableItems.map(item => {
                const weight = item.rarity.chance;
                totalChance += weight;
                return { item, weight };
            });

            if (totalChance === 0) return null;
            
            let random = Math.random() * totalChance;
            let currentWeight = 0;
            
            for (const { item, weight } of itemsWithWeights) {
                currentWeight += weight;
                if (random < currentWeight) {
                    return item;
                }
            }
            // Fallback
            return availableItems[0];
        }

        function generateShopItems() {
            currentShopItems = [];
            let availableItems = SHOP_ITEMS_POOL.filter(item => !item.available || item.available());
            
            for (let i = 0; i < 3; i++) {
                if (availableItems.length === 0) break;
                
                const selectedItem = getRandomItemByRarity();
                if (!selectedItem) break;
                
                currentShopItems.push(selectedItem);
                
                // Entferne das Item, wenn es kein Konsumgut (isConsumable: true) ist
                if (!selectedItem.isConsumable) {
                    availableItems = availableItems.filter(item => item.id !== selectedItem.id);
                }
            }
        }
        
        function renderShop() {
            generateShopItems();
            let html = '';
            currentShopItems.forEach((item, index) => {
                const canAfford = playerGold >= item.cost;
                
                let description = 'Einmaliger Effekt / Passiv.';
                if (item.id === 'damage_reduction') description = 'Reduziert den erlittenen Schaden.';
                if (item.id === 'extra_life_epic') description = 'Verhindert einmal den Tod bei 0 HP.'; // NEU: Klare Erkl√§rung

                html += `
                    <div class="flex justify-between items-center smooth-panel p-3 border-2 ${item.rarity.css}">
                        <div>
                            <p class="text-lg font-bold ${item.rarity.color}">${item.rarity.name}</p>
                            <p class="text-xl font-bold text-white">${item.name}</p>
                            <p class="text-sm text-gray-400">${description}</p>
                        </div>
                        <button onclick="buyShopItem(${index})" 
                                class="smooth-btn py-2 px-4 text-sm ${canAfford ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-500 cursor-not-allowed'}"
                                ${!canAfford ? 'disabled' : ''}>
                            ${item.cost} üí∞
                        </button>
                    </div>
                `;
            });
            ui.shopItemsEl.innerHTML = html;
            ui.updateStatus();
        }

        window.buyShopItem = function(index) {
            const item = currentShopItems[index];
            if (!item || playerGold < item.cost) {
                showNotification("Nicht genug Gold!", 'bg-red-500');
                return;
            }
            
            playerGold -= item.cost;
            item.effect();
            
            // Konsumg√ºter verschwinden nach Kauf, Passiv-Upgrades bleiben in der Liste (bis Reroll)
            if (item.isConsumable || !item.available || item.available()) {
                 currentShopItems.splice(index, 1);
            }
            
            renderShop(); // Shop neu rendern, um gekaufte Items zu entfernen
        }

        window.exitShop = function() {
            currentLevel++;
            ui.changeState(GAME_STATE.PLAYING);
            startEncounter();
        }

        window.backToMenuFromShop = function() {
            saveHighscore(); 
            showNotification(`Run auf Level ${currentLevel} aufgegeben.`, 'bg-red-500');
            ui.changeState(GAME_STATE.MENU);
        }

        // --- PREVIEW CARD LOGIK ---
        
        /** NEU: Zeigt die Preview-UI an und zieht die Karte vom Deck. */
        window.showPreviewUI = function() {
             if (!isGameActive || previewCharges <= 0 || isPreviewing) return;

            previewCharges -= 1;
            previewCard = drawCard(); // Karte ziehen und speichern
            
            ui.showPreviewUI(previewCard);
            ui.updateStatus();
        }
        
        /** Spieler nimmt die Preview-Karte */
        window.acceptPreviewCard = function() {
            if (!isGameActive || !previewCard) return;
            
            ui.hidePreviewUI(); 
            
            ui.addCardToHand(playerHand, previewCard);
            previewCard = null; 
            
            turnCount++;
            doubleDownUsed = true; // Ein Hit z√§hlt immer als Zug

            setTimeout(() => {
                const playerScore = getScore(playerHand);
                if (playerScore > 21) {
                    endGame("Bust nach Seherblick-Hit!", false);
                } else if (playerScore === 21) {
                    stand();
                } else {
                    ui.setControls(true);
                }
            }, 350); 
        }

        /** Spieler lehnt die Preview-Karte ab (sie wird verworfen) */
        window.rejectPreviewCard = function() {
            if (!isGameActive || !previewCard) return;
            
            previewCard = null; // Karte wird verworfen
            ui.hidePreviewUI();
            showNotification("Karte abgelehnt. Zug beendet.", 'bg-red-500');

            // Da der Spieler die Karte ablehnt, gilt das als sein Zug
            turnCount++;
            
            if (getScore(playerHand) > 21) {
                 endGame("Bust nach Ablehnung!", false); // Sollte nicht passieren, aber zur Sicherheit
            } else if (getScore(playerHand) === 21) {
                stand();
            } else {
                ui.setControls(true);
            }
        }

        // --- Cosmetics & Modal Funktionen ---
        window.showHighscores = function() {
            // ... (Funktion bleibt gleich)
            ui.modalTitleEl.textContent = 'Highscores';
            let html = highscores.map((score, index) => 
                `<p class="font-bold">${index + 1}. Level ${score.floor} | Gold: ${score.gold} | (${score.date})</p>`
            ).join('');
            if (highscores.length === 0) html = '<p class="text-center text-gray-400">Noch keine Highscores vorhanden.</p>';
            ui.modalContentEl.innerHTML = html;
            ui.infoModalOverlay.classList.remove('hidden');
        };

        window.showAchievements = function() {
            // ... (Funktion bleibt gleich)
            ui.modalTitleEl.textContent = 'Achievements';
            const achievementsStatus = JSON.parse(localStorage.getItem('achievements') || '[]');
            
            let html = ACHIEVEMENTS.map(a => {
                const storedA = achievementsStatus.find(sa => sa.id === a.id) || a;
                const statusClass = storedA.unlocked ? 'text-green-400' : 'text-gray-500';
                const statusIcon = storedA.unlocked ? '‚úÖ' : 'üîí';
                
                return `<div class="flex justify-between items-center p-2 border-b border-gray-700">
                            <p class="font-bold ${statusClass}">${statusIcon} ${a.name}</p>
                            <span class="${statusClass}">${a.points} ‚≠ê</span>
                        </div>`;
            }).join('');
            
            ui.modalContentEl.innerHTML = html;
            ui.infoModalOverlay.classList.remove('hidden');
        };

        window.closeModal = function() {
            ui.infoModalOverlay.classList.add('hidden');
        };

        window.showCosmeticsShop = function() { 
            ui.changeState(GAME_STATE.COSMETICS);
            renderCosmeticsShop();
        };

        // KORRIGIERT: Layout und Funktionalit√§t des Cosmetics Shops
        function renderCosmeticsShop() {
            const container = document.getElementById('card-back-shop-items');
            let html = '';
            
            CARD_BACK_SKINS.forEach(skin => {
                const isUnlocked = unlockedSkins.includes(skin.id);
                const isEquipped = equippedSkin === skin.id;
                const canBuy = totalPoints >= skin.cost;
                
                html += `
                    <div class="smooth-panel p-4 text-center flex flex-col items-center justify-between border-2 ${isEquipped ? 'border-purple-400' : isUnlocked ? 'border-green-400' : 'border-gray-700'}">
                        <p class="font-bold text-lg mb-2 ${isEquipped ? 'text-purple-300' : 'text-white'}">${skin.name}</p>
                        <div class="card card-back w-20 h-28 my-2 ${skin.cssClass} !transform-none !opacity-100 cursor-pointer" onclick="${isUnlocked ? `equipSkin('${skin.id}')` : ''}">R21</div>
                        
                        ${isEquipped ? 
                            `<span class="text-lg font-black text-purple-400 mt-2">AUSGER√úSTET</span>` 
                            : isUnlocked ? 
                                `<button onclick="equipSkin('${skin.id}')" class="smooth-btn bg-green-600 hover:bg-green-700 text-white w-full py-2 text-sm mt-2">Ausr√ºsten</button>` 
                                : 
                                `<button onclick="buySkin('${skin.id}', ${skin.cost})" 
                                        class="smooth-btn w-full py-2 text-sm mt-2 ${canBuy ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-gray-500 cursor-not-allowed'}" 
                                        ${!canBuy ? 'disabled' : ''}>
                                    Kaufen (${skin.cost} ‚≠ê)
                                </button>`
                        }
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        window.buySkin = function(skinId, cost) {
            // ... (Funktion bleibt gleich)
            if (totalPoints < cost) {
                showNotification("Nicht genug Punkte!", 'bg-red-500');
                return;
            }
            totalPoints -= cost;
            unlockedSkins.push(skinId);
            localStorage.setItem('totalPoints', totalPoints.toString());
            localStorage.setItem('unlockedSkins', JSON.stringify(unlockedSkins));
            showNotification(`${CARD_BACK_SKINS.find(s => s.id === skinId).name} freigeschaltet!`, 'bg-green-600');
            renderCosmeticsShop();
        }

        window.equipSkin = function(skinId) {
            // ... (Funktion bleibt gleich)
            equippedSkin = skinId;
            localStorage.setItem('equippedSkin', skinId);
            showNotification(`Neuer Kartenr√ºcken: ${CARD_BACK_SKINS.find(s => s.id === skinId).name}!`, 'bg-purple-600');
            renderCosmeticsShop();
        }

        // --- SPIEL-LOOP LOGIK ---
        
        /** Initialisiert die Daten f√ºr einen neuen Run. */
        window.startNewRun = function() {
            playerHealth = 100;
            maxHealth = 100;
            playerGold = 0;
            currentLevel = 1;
            goldMultiplier = 1;
            rerollCharges = 0; 
            bossHealth = 0; 
            gameMode = GAME_MODE.STANDARD;
            blackjackMultiplier = 1; 
            hasExtraLife = false; 
            dealerRiskLevel = 0; 
            previewCharges = 0; // ZUR√úCKSETZEN
            
            ui.changeState(GAME_STATE.PLAYING);
            startEncounter();
        }

        /** Setzt den Spielstand zur√ºck und startet einen neuen Run. */
        window.resetGame = function() {
            ui.changeState(GAME_STATE.MENU);
        }

        /** Startet eine neue Blackjack-Runde f√ºr den aktuellen Level. */
        window.startEncounter = function() {
            if (playerHealth <= 0) return ui.changeState(GAME_STATE.GAMEOVER);

            turnCount = 0;
            doubleDownUsed = false;
            previewCard = null; 
            isPreviewing = false;
            
            if (currentLevel > 0 && currentLevel % 10 === 0) {
                if (gameMode !== GAME_MODE.BOSS || bossHealth <= 0) {
                    gameMode = GAME_MODE.BOSS;
                    bossMaxHealth = 50 + (currentLevel / 10) * 15;
                    bossHealth = bossMaxHealth;
                    showNotification(`BOSS ALARM! Level ${currentLevel} - Das ist der Endgegner!`, 'bg-red-700', 5000);
                } else {
                    showNotification(`Runde ${currentLevel} - Kampf fortgesetzt!`, 'bg-red-500', 1000);
                    gameMode = GAME_MODE.BOSS; 
                }
            } else {
                gameMode = GAME_MODE.STANDARD;
                bossHealth = 0; 
            }

            deck = createDeck();
            playerHand = [];
            dealerHand = [];
            isGameActive = true;

            ui.playerHandEl.innerHTML = '';
            ui.dealerHandEl.innerHTML = '';


            ui.addCardToHand(playerHand, drawCard());
            setTimeout(() => ui.addCardToHand(dealerHand, drawCard(), true), 100);
            setTimeout(() => ui.addCardToHand(playerHand, drawCard()), 200);
            setTimeout(() => ui.addCardToHand(dealerHand, drawCard(), true), 300);

            ui.updateStatus();
            ui.setControls(true);
            ui.showMessage(`Level ${currentLevel}: Mach deinen Zug! ${gameMode === GAME_MODE.BOSS ? '‚Äî BOSS FIGHT!' : ''}`);
            
            setTimeout(checkBlackjack, 500); 
        }

        /** √úberpr√ºft auf Blackjack zu Beginn */
        function checkBlackjack() {
            // ... (Funktion bleibt gleich)
            const playerScore = getScore(playerHand);
            const dealerScore = getScore(dealerHand);

            if (playerScore === 21) {
                // Blackjack Tanz Animation direkt auf die Karten
                const cards = ui.playerHandEl.querySelectorAll('.card');
                cards.forEach(card => card.classList.add('blackjack-dance'));

                setTimeout(() => {
                    cards.forEach(card => card.classList.remove('blackjack-dance'));
                    ui.updateHands(true);
                    if (dealerScore === 21) {
                        endGame("Push! Unentschieden.", true, true);
                    } else {
                        endGame("BLACKJACK! Du gewinnst.", true, false, true); // isBlackjack
                    }
                }, 1000);
            } else if (dealerScore === 21) {
                setTimeout(() => ui.updateHands(true), 300); 
                endGame("Dealer Blackjack!", false);
            }
        }

        /** Spieler zieht eine Karte. */
        window.hit = function() {
            if (!isGameActive) return;
            turnCount++;
            
            // NEU/KORRIGIERT: DoubleDown wird hier NICHT auf true gesetzt. 
            // DoubleDown ist nur ein spezifischer Zug, kein genereller Zustand nach dem ersten Hit.
            // doubleDownUsed wird erst bei doubleDown() auf true gesetzt.

            ui.addCardToHand(playerHand, drawCard()); 

            setTimeout(() => {
                const playerScore = getScore(playerHand);

                if (playerScore > 21) {
                    endGame("Bust! Du hast √ºberkauft.", false);
                } else if (playerScore === 21) {
                    stand();
                } else {
                    ui.setControls(true);
                }
            }, 350); 
            
            ui.setControls(false);
            ui.updateStatus();
        }
        
        /** KORRIGIERT: Double Down Funktion */
        window.doubleDown = function() {
            // Pr√ºfung: nur im ersten Zug (turnCount === 0), nicht bereits verwendet
            if (!isGameActive || turnCount !== 0 || doubleDownUsed || getScore(playerHand) > 21) return;
            
            showNotification("DOUBLE DOWN! N√§chste Karte ist deine letzte.", 'bg-yellow-600');
            
            turnCount++;
            doubleDownUsed = true; // ZWINGEND auf true setzen

            ui.addCardToHand(playerHand, drawCard());
            
            setTimeout(() => {
                // Nach dem Ziehen der Double-Karte ist die Runde beendet, egal ob Bust oder nicht.
                if (getScore(playerHand) > 21) {
                    endGame("Double Down Bust!", false, false, false, true); // isDoubleDown = true
                } else {
                    stand();
                }
            }, 350);
            
            ui.setControls(false);
            ui.updateStatus();
        }
        
        /** Split Funktion (Platzhalter) */
        window.splitHand = function() {
            // ... (Funktion bleibt gleich)
            if (!isGameActive || turnCount !== 0 || playerHand.length !== 2 || playerHand[0].value !== playerHand[1].value) return;

            showNotification("SPLIT! Feature ist vorbereitet, aber noch nicht aktiv. Versuche es sp√§ter!", 'bg-red-500', 3000);
        }

        /** Spieler bleibt stehen, Dealer ist an der Reihe. */
        window.stand = function() {
            if (!isGameActive) return;

            ui.setControls(false);
            ui.updateHands(true); 

            let dealerInterval = setInterval(() => {
                let dealerScore = getScore(dealerHand);
                // NEU: Dealer Risikolevel (16 bei Risiko, 17 Standard)
                const dealerStandThreshold = (dealerRiskLevel === 1) ? 16 : 17;

                if (dealerScore < dealerStandThreshold) {
                    ui.addCardToHand(dealerHand, drawCard(), true);
                    ui.updateHands(true);
                } else {
                    clearInterval(dealerInterval);
                    evaluateResult();
                }
            }, 400); 
        }

        /** Auswertung des Ergebnisses nach Dealer-Zug. */
        function evaluateResult() {
            const dealerScore = getScore(dealerHand);
            const playerScore = getScore(playerHand);
            
            // Check if player busted during his turn (should be handled by hit/doubleDown, but safety check)
            if (playerScore > 21) {
                 endGame("Bust! Du hast √ºberkauft.", false);
                 return;
            }
            
            if (dealerScore > 21) {
                endGame("Dealer Bust! Du gewinnst!", true);
            } else if (playerScore > dealerScore) {
                endGame("Du hast gewonnen!", true);
            } else if (playerScore < dealerScore) {
                endGame("Der Dealer gewinnt!", false);
            } else {
                endGame("Push! Unentschieden.", true, true);
            }
        }

        /** Beendet die Runde und berechnet Gewinn/Verlust. */
        function endGame(message, playerWon, isPush = false, isBlackjack = false, isDoubleDown = false) { 
            isGameActive = false;
            ui.setControls(false);

            let goldChange = 0;
            let baseDamage = 0;
            let healthDamage = 0;
            
            if (isPush) {
                ui.showMessage(message, true);
                setTimeout(nextAction, 1500);
                return; 
            }
            
            if (playerWon) {
                currentLevel++; // Level Z√§hler wird jetzt immer hier erh√∂ht
                
                // Grund-Gold (mit Multiplikatoren)
                let baseGold = 30;
                
                if (isBlackjack) {
                    baseGold *= 1.5 * blackjackMultiplier; 
                }
                
                goldChange = Math.floor(baseGold * goldMultiplier);
                
                if (isDoubleDown) {
                    goldChange *= 2; // Double Down verdoppelt den Gewinn
                    message += " (x2 Gold)";
                }
                
                if (gameMode === GAME_MODE.BOSS) {
                    const damage = getScore(playerHand);
                    bossHealth -= damage;
                    
                    if (bossHealth <= 0) {
                        message = "BOSS besiegt! Du erh√§ltst Bonus-Gold.";
                        goldChange += Math.floor(150 * goldMultiplier);
                        gameMode = GAME_MODE.STANDARD; 
                    } else {
                        message = `BOSS Schaden: ${damage}! HP: ${bossHealth}/${bossMaxHealth}.`;
                        goldChange += Math.floor(30 * goldMultiplier); 
                    }
                }

                playerGold += goldChange;
                ui.showMessage(`${message} (+${goldChange} üí∞)`, true);

            } else {
                // Verlust: Schaden erleiden
                if (gameMode === GAME_MODE.BOSS) {
                    baseDamage = Math.floor(20 + (currentLevel / 10) * 5); 
                } else {
                    baseDamage = Math.floor(7 + currentLevel * 1.0);
                }
                
                // Bust (egal ob normal oder DoubleDown) verursacht halben Schaden
                if (message.includes("Bust")) baseDamage = Math.floor(baseDamage / 2);
                
                healthDamage = baseDamage;

                playerHealth -= healthDamage;
                
                // Ph√∂nix-Amulett (Extra Life) Logik
                if (playerHealth <= 0 && hasExtraLife) {
                    playerHealth = 1;
                    hasExtraLife = false;
                    showNotification("Das Ph√∂nix-Amulett hat dich gerettet!", 'bg-purple-600', 3000);
                }
                
                if (playerHealth <= 0) {
                    playerHealth = 0; 
                    ui.showMessage(`${message} (-${healthDamage} ‚ù§Ô∏è)`, true);
                    saveHighscore(); 
                    setTimeout(() => ui.changeState(GAME_STATE.GAMEOVER), 2000);
                    return; 
                }
                
                ui.showMessage(`${message} (-${healthDamage} ‚ù§Ô∏è)`, true);
            }

            ui.updateStatus();
            setTimeout(nextAction, 1500);
        }
        
        /** Entscheidet, was als N√§chstes passiert: Shop oder neuer Encounter */
        function nextAction() {
            if (playerHealth <= 0) {
                saveHighscore();
                ui.changeState(GAME_STATE.GAMEOVER);
                return;
            }

            if (gameMode === GAME_MODE.BOSS && bossHealth > 0) {
                startEncounter(); 
                return;
            }
            
            // Level nach dem Sieg erh√∂ht
            if (currentLevel > 1 && (currentLevel - 1) % 3 === 0 && currentLevel % 10 !== 0) {
                renderShop();
                ui.changeState(GAME_STATE.SHOP);
            } else {
                startEncounter();
            }
        }
        
        // --- INITIALISIERUNG (Start der App) ---
        
        /** Startet die gesamte Anwendung. */
        function initialize() {
            // ... (Funktion bleibt gleich)
            const storedAchievements = JSON.parse(localStorage.getItem('achievements') || '[]');
            storedAchievements.forEach(storedA => {
                const index = ACHIEVEMENTS.findIndex(a => a.id === storedA.id);
                if (index !== -1) {
                    ACHIEVEMENTS[index].unlocked = storedA.unlocked;
                }
            });
            
            playerHealth = 100;
            maxHealth = 100;

            ui.updateStatus();
            ui.changeState(GAME_STATE.MENU); 
            
            document.getElementById('game-over-overlay').classList.add('hidden');
        }

        // Starte die App, wenn das Dokument vollst√§ndig geladen ist
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>