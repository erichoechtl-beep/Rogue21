import random
import time

# --- Spielkonstanten und Globale Variablen ---
SPIELNAME = "Rogue21"
MAX_GOLD = 999
WETT_MIN = 10
WETT_MAX = 100

# Seltenheitskategorien (Farbe, Name, Chance (als Dezimalwert))
SELTENHEITEN = {
    'GewÃ¶hnlich': {'farbe': 'ğŸŸ¢', 'chance': 0.50},
    'UngewÃ¶hnlich': {'farbe': 'ğŸ”µ', 'chance': 0.30},
    'Selten': {'farbe': 'ğŸŸ¡', 'chance': 0.15},
    'Episch': {'farbe': 'ğŸŸ£', 'chance': 0.04},
    'LegendÃ¤r': {'farbe': 'ğŸŸ ', 'chance': 0.01}
}

# Shop-GegenstÃ¤nde mit Seltenheit und Kosten
SHOP_GEGENSTAENDE = {
    "Rogue-Skin (Keanu)": {"kosten": 100, "effekt": "Visuell", "seltenheit": "GewÃ¶hnlich"},
    "Rogue-Skin (Terminator)": {"kosten": 150, "effekt": "Visuell", "seltenheit": "UngewÃ¶hnlich"},
    "KartenzÃ¤hler": {"kosten": 200, "effekt": "Zeigt nÃ¤chste Karte des Decks (einmalig)", "seltenheit": "Selten"},
    "GlÃ¼cks-Multiplikator": {"kosten": 180, "effekt": "ErhÃ¶ht Blackjack-Auszahlung auf 2:1 (Passiv)", "seltenheit": "Selten"},
    "Amulett der ErlÃ¶sung": {"kosten": 350, "effekt": "Verhindert einmalig den Tod bei 0 HP (Passiv)", "seltenheit": "Episch"},
    "Voraussicht-Token": {"kosten": 50, "effekt": "NÃ¤chste Karte sehen und entscheiden (einmalig)", "seltenheit": "GewÃ¶hnlich"},
    "HÃ¤ndler-Provokation": {"kosten": 400, "effekt": "Dealer spielt risikoreicher (einmalig)", "seltenheit": "LegendÃ¤r"}
}

# Spieler-Status
spieler_gold = 100
spieler_hp = 3
spieler_inventar = []
aktueller_skin = "Standard"

def karte_ziehen(deck):
    """Zieht eine Karte vom Deck."""
    return deck.pop()

def kartenwert_berechnen(hand):
    """Berechnet den Punktewert einer Hand."""
    wert = 0
    anzahl_asse = 0
    for karte in hand:
        if karte[0] in ['K', 'D', 'B', '10']:
            wert += 10
        elif karte[0] == 'A':
            wert += 11
            anzahl_asse += 1
        else:
            wert += int(karte[0])
    
    # Korrektur fÃ¼r Asse (von 11 auf 1 reduzieren, wenn Ã¼ber 21)
    while wert > 21 and anzahl_asse > 0:
        wert -= 10
        anzahl_asse -= 1
    return wert

def deck_mischen():
    """Erstellt und mischt ein neues Deck."""
    werte = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'B', 'D', 'K']
    farben = ['â™¥', 'â™¦', 'â™£', 'â™ ']
    deck = [(wert, farbe) for wert in werte for farbe in farben] * 4 # 4 Decks
    random.shuffle(deck)
    return deck

def anzeigen_hand(hand, verdeckt=False, titel=""):
    """Zeigt die Kartenhand an."""
    karten_str = []
    for i, karte in enumerate(hand):
        if verdeckt and i == 1: # Zweite Karte des Dealers verbergen
            karten_str.append("[???]")
        else:
            karten_str.append(f"[{karte[0]}{karte[1]}]")
    
    wert = kartenwert_berechnen(hand) if not verdeckt or len(hand) == 1 else "?"
    print(f"\n--- {titel} (Wert: {wert}) ---")
    print(" ".join(karten_str))
    print("----------------------------")

def print_status():
    """Zeigt den aktuellen Status des Spielers."""
    global spieler_gold, spieler_hp, aktueller_skin
    print(f"\n======================================")
    print(f" {SPIELNAME} - Spielerstatus")
    print(f"======================================")
    print(f" ğŸ’° Gold: {spieler_gold}")
    print(f" â¤ï¸ HP: {spieler_hp}")
    print(f" ğŸ­ Skin: {aktueller_skin}")
    if spieler_inventar:
        inventar_liste = ", ".join([item for item in spieler_inventar if item not in ["GlÃ¼cks-Multiplikator", "Amulett der ErlÃ¶sung"]])
        passiv_effekte = []
        if "GlÃ¼cks-Multiplikator" in spieler_inventar:
            passiv_effekte.append("Blackjack: 2:1")
        if "Amulett der ErlÃ¶sung" in spieler_inventar:
            passiv_effekte.append("Todesverhinderung")
        
        print(f" ğŸ’ Inventar: {inventar_liste}")
        if passiv_effekte:
            print(f" âœ¨ Passiv: {', '.join(passiv_effekte)}")
    else:
        print(" ğŸ’ Inventar: Leer")
    print(f"======================================")

# --- NEUE FUNKTIONEN ---

def shop_oeffnen():
    """Implementiert den Shop mit seltenen GegenstÃ¤nden."""
    global spieler_gold, spieler_inventar, aktueller_skin

    def karte_ziehen_mit_seltenheit(gegenstand):
        """WÃ¤hlt eine Seltenheit basierend auf den Chancen und gibt die entsprechende Farbe zurÃ¼ck."""
        seltenheit = gegenstand['seltenheit']
        return SELTENHEITEN[seltenheit]['farbe']

    while True:
        print("\n" + "="*40)
        print(f"| {SPIELNAME} - DER VERSTECKTE HÃ„NDLER |")
        print("="*40)
        print(f"| Dein Gold: {spieler_gold} Gold")
        print("-" * 40)
        
        i = 1
        shop_liste = list(SHOP_GEGENSTAENDE.items())
        for name, details in shop_liste:
            farbe = karte_ziehen_mit_seltenheit(details)
            print(f"| {i}. {farbe} {name} ({details['seltenheit']}) - {details['kosten']} Gold")
            print(f"|    Effekt: {details['effekt']}")
            i += 1
        
        print("-" * 40)
        print("| K. Kaufen | Z. ZurÃ¼ck")
        print("=" * 40)

        wahl = input("Was mÃ¶chtest du tun? (1-{}) / K / Z: ".format(len(shop_liste))).upper()

        if wahl == 'Z':
            break
        elif wahl == 'K':
            item_nummer = input("Welche Nummer mÃ¶chtest du kaufen? ")
            try:
                item_nummer = int(item_nummer)
                if 1 <= item_nummer <= len(shop_liste):
                    name, details = shop_liste[item_nummer - 1]
                    kosten = details['kosten']
                    
                    if name in spieler_inventar and details['effekt'] in ["Passiv", "Todesverhinderung"]:
                        print("Du besitzt diesen passiven Gegenstand bereits!")
                        continue
                    
                    if spieler_gold >= kosten:
                        spieler_gold -= kosten
                        
                        if "Skin" in name:
                            aktueller_skin = name.split('(')[1].replace(')', '')
                            print(f"âœ… Du hast den Skin '{aktueller_skin}' gekauft und ausgerÃ¼stet!")
                        elif details['effekt'] in ["Passiv", "Todesverhinderung"]:
                            spieler_inventar.append(name)
                            print(f"âœ… Du hast '{name}' gekauft und es ist nun passiv aktiv!")
                        else:
                            spieler_inventar.append(name)
                            print(f"âœ… Du hast '{name}' fÃ¼r dein Inventar gekauft!")
                        
                        time.sleep(1)
                    else:
                        print("âŒ Nicht genug Gold!")
                else:
                    print("UngÃ¼ltige Nummer.")
            except ValueError:
                print("UngÃ¼ltige Eingabe.")
        else:
            print("UngÃ¼ltige Auswahl.")

# --- Hauptlogik fÃ¼r das Spiel ---

def spielrunde():
    """FÃ¼hrt eine einzelne Runde Blackjack durch."""
    global spieler_gold, spieler_hp, spieler_inventar
    deck = deck_mischen()
    
    print_status()

    # Wette setzen
    while True:
        try:
            wette = int(input(f"Setze deine Wette ({WETT_MIN}-{WETT_MAX} Gold): "))
            if WETT_MIN <= wette <= WETT_MAX and wette <= spieler_gold:
                break
            elif wette > spieler_gold:
                print("âŒ Du kannst nicht mehr wetten, als du hast!")
            else:
                print(f"âŒ Die Wette muss zwischen {WETT_MIN} und {WETT_MAX} liegen.")
        except ValueError:
            print("âŒ UngÃ¼ltige Eingabe. Bitte gib eine Zahl ein.")
    
    # HÃ¤nde austeilen
    spieler_hand = [karte_ziehen(deck), karte_ziehen(deck)]
    dealer_hand = [karte_ziehen(deck), karte_ziehen(deck)]
    
    # Spieleinstellungen aus Inventar prÃ¼fen
    dealer_risiko = "HÃ¤ndler-Provokation" in spieler_inventar
    if dealer_risiko:
        spieler_inventar.remove("HÃ¤ndler-Provokation")
        print("\nğŸ”¥ HÃ¤ndler-Provokation aktiv! Der Dealer wird risikoreicher spielen.")
        time.sleep(1)
        
    # Blackjack-PrÃ¼fung nach Austeilen
    spieler_wert = kartenwert_berechnen(spieler_hand)
    dealer_wert = kartenwert_berechnen(dealer_hand)
    
    # Sofortige Blackjack-Animation
    if spieler_wert == 21:
        print("\n" + "#" * 50)
        print("####### ğŸ’¥ BLACKJACK!!! ğŸ’¥ #######")
        print("####### ğŸŠğŸ‰ WIRKLICH COOL! ğŸ‰ğŸŠ #######")
        print("#" * 50 + "\n")
        time.sleep(2)
        
    if spieler_wert == 21 and dealer_wert != 21:
        auszahlung = 2 if "GlÃ¼cks-Multiplikator" in spieler_inventar else 1.5
        gewinn = int(wette * auszahlung)
        spieler_gold += gewinn
        print(f"ğŸ‰ BLACKJACK! Du gewinnst {gewinn} Gold! (Auszahlung {auszahlung}:1)")
        return
    elif spieler_wert == 21 and dealer_wert == 21:
        print("ğŸ¤ Push! Unentschieden bei Blackjack. Einsatz zurÃ¼ck.")
        return
    
    # Spielerzug
    haende_zu_spielen = [(spieler_hand, wette)] # (Hand, Wette)
    neue_haende = []
    
    for hand_index, (hand, hand_wette) in enumerate(haende_zu_spielen):
        print(f"\n--- HAND {hand_index + 1} START (Wette: {hand_wette} Gold) ---")
        
        while True:
            anzeigen_hand(hand, titel=f"Deine Hand {hand_index + 1}")
            anzeigen_hand(dealer_hand, verdeckt=True, titel="Dealer")
            
            wert = kartenwert_berechnen(hand)
            if wert > 21:
                print("ğŸ’¥ Bust! Ãœberkauft.")
                spieler_gold -= hand_wette
                break
            
            aktionen = ["H. Hit (Karte ziehen)", "S. Stand (Stehenbleiben)"]
            
            # Double Down Option
            if len(hand) == 2 and spieler_gold >= hand_wette:
                aktionen.append(f"D. Double Down (Verdoppelt Goldgewinn diese Runde - Kostet {hand_wette} Gold)")
            
            # Split Option
            if len(hand) == 2 and hand[0][0] == hand[1][0] and spieler_gold >= hand_wette:
                aktionen.append(f"P. Split (Teilen)")

            # Voraussicht-Token Option
            if "Voraussicht-Token" in spieler_inventar:
                aktionen.append("V. Voraussicht-Token nutzen (NÃ¤chste Karte sehen)")

            print("\nOptionen: " + " | ".join(aktionen))
            wahl = input("Deine Wahl: ").upper()
            
            if wahl == 'H':
                hand.append(karte_ziehen(deck))
            elif wahl == 'S':
                neue_haende.append((hand, hand_wette))
                break
            elif wahl == 'D' and len(hand) == 2 and spieler_gold >= hand_wette:
                hand_wette *= 2
                hand.append(karte_ziehen(deck))
                spieler_gold -= hand_wette / 2 # Abzug des verdoppelten Einsatzes
                neue_haende.append((hand, hand_wette))
                print(f"ğŸš€ Double Down! Neuer Einsatz: {hand_wette} Gold. Letzte Karte gezogen.")
                break
            elif wahl == 'P' and len(hand) == 2 and hand[0][0] == hand[1][0] and spieler_gold >= hand_wette:
                neue_hand1 = [hand[0], karte_ziehen(deck)]
                neue_hand2 = [hand[1], karte_ziehen(deck)]
                
                # Wenn Asse geteilt werden, darf man nur eine Karte ziehen (Regel)
                if hand[0][0] == 'A':
                    print("â™ ï¸ Asse geteilt! Nur eine Karte pro Hand erlaubt.")
                    neue_haende.extend([(neue_hand1, hand_wette), (neue_hand2, hand_wette)])
                    spieler_gold -= hand_wette # Abzug fÃ¼r den Split-Einsatz
                    break
                
                haende_zu_spielen.extend([(neue_hand1, hand_wette), (neue_hand2, hand_wette)])
                spieler_gold -= hand_wette # Abzug fÃ¼r den Split-Einsatz
                print("âœ‚ï¸ Split! Zwei neue HÃ¤nde werden gespielt.")
                break
            elif wahl == 'V' and "Voraussicht-Token" in spieler_inventar:
                naechste_karte = deck[-1] # NÃ¤chste Karte sehen, ohne sie zu ziehen
                print(f"ğŸ”® Die nÃ¤chste Karte im Deck ist: [{naechste_karte[0]}{naechste_karte[1]}]")
                nutzen = input("MÃ¶chtest du diese Karte ziehen (J/N)? ").upper()
                spieler_inventar.remove("Voraussicht-Token")
                
                if nutzen == 'J':
                    hand.append(karte_ziehen(deck))
                    print("Du hast die Karte gezogen!")
                else:
                    print("Du hast dich entschieden, diese Karte nicht zu ziehen.")
                
            else:
                print("âŒ UngÃ¼ltige Aktion oder Option nicht verfÃ¼gbar.")

    # Dealer-Zug, falls der Spieler noch im Spiel ist
    dealer_spielt = any(kartenwert_berechnen(h) <= 21 for h, w in neue_haende)
    if dealer_spielt:
        print("\n--- Dealer spielt ---")
        anzeigen_hand(dealer_hand, verdeckt=False, titel="Dealer")

        # Dealer-Regel: Ziehen bis mindestens 17. Bei Risiko (Provokation) bis 16.
        min_dealer_wert = 17
        if dealer_risiko:
            min_dealer_wert = 16
            
        while kartenwert_berechnen(dealer_hand) < min_dealer_wert:
            time.sleep(1)
            neue_karte = karte_ziehen(deck)
            dealer_hand.append(neue_karte)
            print(f"Dealer zieht: [{neue_karte[0]}{neue_karte[1]}]")
            anzeigen_hand(dealer_hand, verdeckt=False, titel="Dealer")
        
        dealer_wert = kartenwert_berechnen(dealer_hand)
        if dealer_wert > 21:
            print("Dealer Bust! Alle verbleibenden SpielerhÃ¤nde gewinnen.")
        else:
            print(f"Dealer bleibt bei {dealer_wert}.")

    # Auswertung aller gespielten HÃ¤nde
    print("\n--- Auswertung ---")
    dealer_wert = kartenwert_berechnen(dealer_hand)
    
    for hand, wette in neue_haende:
        spieler_wert = kartenwert_berechnen(hand)
        print(f"Hand (Wert: {spieler_wert}, Wette: {wette}): ", end="")

        if spieler_wert > 21:
            print("Verloren (Bust).")
            spieler_gold -= wette
        elif dealer_wert > 21 or spieler_wert > dealer_wert:
            print(f"Gewonnen! Gewinn: {wette} Gold.")
            spieler_gold += wette
        elif spieler_wert == dealer_wert:
            print("Unentschieden (Push). Einsatz zurÃ¼ck.")
        else:
            print("Verloren.")
            spieler_gold -= wette

    # HP-Regelung am Ende der Runde
    if spieler_gold <= 0:
        spieler_hp -= 1
        print(f"\nâš ï¸ Du hast dein Gold verloren und verlierst 1 HP. Aktuelle HP: {spieler_hp}")
        
        # Amulett der ErlÃ¶sung prÃ¼fen
        if spieler_hp <= 0 and "Amulett der ErlÃ¶sung" in spieler_inventar:
            spieler_hp = 1
            spieler_inventar.remove("Amulett der ErlÃ¶sung")
            print("âœ¨ Amulett der ErlÃ¶sung aktiviert! Dein Tod wurde verhindert. Das Amulett ist nun verbraucht.")
        
        # Falls kein Gold mehr da ist, aber noch HP, wird Startgold gesetzt
        if spieler_gold <= 0 and spieler_hp > 0:
            spieler_gold = 50
            print("Neues Startkapital von 50 Gold erhalten.")

def main():
    """Hauptfunktion des Spiels."""
    print(f"Willkommen bei {SPIELNAME}!")
    
    global spieler_hp

    while spieler_hp > 0:
        print_status()
        
        print("\nWas mÃ¶chtest du tun?")
        print("S. Spielen (Starte eine Runde Blackjack)")
        print("K. Shop (Kaufe Upgrades)")
        print("B. Beenden")
        
        wahl = input("Deine Wahl: ").upper()
        
        if wahl == 'S':
            spielrunde()
        elif wahl == 'K':
            shop_oeffnen()
        elif wahl == 'B':
            break
        else:
            print("UngÃ¼ltige Eingabe.")

    print(f"\n--- GAME OVER ---")
    print(f"Dein Abenteuer endet hier. Dein letztes Gold: {spieler_gold}")
    print("-----------------")

if __name__ == "__main__":
    main()