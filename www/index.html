<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rogue 21 Boss Edition</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Stellt sicher, dass die App den gesamten Bildschirm einnimmt */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            min-height: 100vh; /* Mindestens die H√∂he des Viewports */
            overflow: hidden; 
            box-sizing: border-box;
        }

        body {
            display: flex;
            flex-direction: column;
            background-color: #1f2937; /* Dunkler Hintergrund, passend zu den UI-Farben */
            font-family: ui-sans-serif, system-ui, sans-serif;
        }
        
        /* Haupt-Container-Layout */
        #app-container {
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%; 
            padding: 1rem;
            max-width: 900px; /* Optional: Maximale Breite f√ºr Desktop-Ansicht */
            margin: 0 auto; /* Zentriert auf gro√üen Bildschirmen */
        }
        
        /* Karten-Styling */
        .card {
            background-color: white;
            color: black;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 75px;
            height: 110px;
            display: inline-flex; /* Anpassung f√ºr Android 6 Kompatibilit√§t */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0 4px 8px 4px; /* Abstand zwischen den Karten */
            position: relative;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
            font-weight: bold;
            transform-origin: bottom center;
            animation: deal 0.5s ease-out forwards;
            opacity: 0;
            vertical-align: top;
        }

        .suit-red { color: #dc2626; } /* Rot f√ºr Herz und Karo */
        .suit-black { color: #1f2937; } /* Dunkelblau/Schwarz f√ºr Kreuz und Pik */

        .card-back {
            background-color: #4f46e5; /* Standard Lila */
            color: white;
            border-color: #6366f1;
            font-size: 20px;
            font-family: monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            
            /* SKINS */
            &.skin-gold { background-color: #f59e0b; border-color: #fbbf24; }
            &.skin-cyber { background-color: #1e3a8a; border-color: #3b82f6; }
            &.skin-crimson { background-color: #991b1b; border-color: #ef4444; }
        }

        /* Animation f√ºr das Austeilen der Karten */
        @keyframes deal {
            0% { transform: translateY(-50px) scale(0.5); opacity: 0; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }

        /* Allgemeine UI-Klassen */
        .smooth-panel {
            background-color: #374151;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid #4b5563;
        }
        .smooth-btn {
            border-radius: 6px;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.1s;
        }
        .smooth-btn:hover:not(:disabled) {
            transform: translateY(-1px);
        }
        .smooth-btn:active:not(:disabled) {
            transform: translateY(0);
        }
        .smooth-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Notification Box */
        #notification-box {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            padding: 10px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            transition: transform 0.5s ease-out, opacity 0.5s;
            opacity: 0;
        }
        #notification-box.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body class="text-white">
    <div id="app-container" class="space-y-4">

        <div class="flex justify-between items-center smooth-panel p-3">
            <div class="flex items-center space-x-4">
                <span id="player-health" class="text-red-400 font-black text-xl">100/100 ‚ù§Ô∏è</span>
                <span id="player-gold" class="text-yellow-400 font-black text-xl">0 üí∞</span>
                <span id="reroll-charges-display" class="text-blue-400 font-black text-xl">W√ºrfel: 0</span>
            </div>
            <span id="current-floor" class="text-lg font-black bg-blue-700 py-1 px-3 rounded-full">Encounter 1</span>
        </div>
        
        <div id="boss-status-bar" class="smooth-panel p-3 bg-red-800/50 border-red-500 hidden">
            <p class="font-bold text-center mb-1">BOSS HEALTH</p>
            <div class="relative pt-1">
                <div class="overflow-hidden h-4 mb-4 text-xs flex rounded bg-red-200">
                    <div id="boss-health-bar" style="width: 100%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-red-500 transition-all duration-300 ease-out"></div>
                </div>
                <div id="boss-health" class="absolute top-0 left-0 right-0 text-center font-black text-xs text-white"></div>
            </div>
        </div>

        <div id="notification-box" class="hidden"></div>
        
        <div id="main-menu" class="flex-grow flex flex-col justify-center items-center space-y-6">
            <h1 class="text-6xl font-black text-yellow-400 drop-shadow-lg">Rogue 21</h1>
            <h2 class="text-2xl font-bold text-red-500 drop-shadow-lg">Boss Edition</h2>

            <button onclick="startNewRun()" class="smooth-btn bg-green-600 hover:bg-green-700 text-white w-64 py-4 text-xl">Neuer Run</button>
            <button onclick="showCosmeticsShop()" class="smooth-btn bg-purple-600 hover:bg-purple-700 text-white w-64 py-4 text-xl">Skins & Punkte (<span id="total-points">0</span> ‚≠ê)</button>
            <button onclick="showHighscores()" class="smooth-btn bg-blue-600 hover:bg-blue-700 text-white w-64 py-4 text-xl">Highscores</button>
            <button onclick="showAchievements()" class="smooth-btn bg-gray-600 hover:bg-gray-700 text-white w-64 py-4 text-xl">Achievements</button>
        </div>

        <div id="gameplay-state" class="flex-grow flex flex-col justify-between hidden">
            <div class="smooth-panel p-3 mb-2">
                <h3 id="dealer-title" class="text-lg font-bold text-center mb-2">Dealer's Hand</h3>
                <div id="dealer-hand" class="flex justify-center flex-wrap">
                    </div>
            </div>
            
            <div id="message-box" class="text-center font-black text-2xl py-3 rounded-lg my-4 transition-colors duration-300">Mach deinen Zug!</div>

            <div class="smooth-panel p-3 mt-2">
                <h3 class="text-lg font-bold text-center mb-2">Deine Hand (<span id="player-score">0</span>)</h3>
                <div id="player-hand" class="flex justify-center flex-wrap">
                    </div>
            </div>

            <div class="flex justify-center space-x-4 pt-4 pb-2">
                <button id="btn-hit" onclick="hit()" class="smooth-btn bg-green-500 hover:bg-green-600 w-40 py-3 text-lg">Hit (Karte ziehen)</button>
                <button id="btn-stand" onclick="stand()" class="smooth-btn bg-red-500 hover:bg-red-600 w-40 py-3 text-lg">Stand (Stehen)</button>
            </div>
        </div>

        <div id="shop-container" class="flex-grow flex flex-col justify-center hidden">
            <div class="smooth-panel p-6 space-y-4">
                <h2 class="text-3xl font-black text-center text-yellow-400 mb-4">Shop</h2>
                <div class="flex justify-between items-center text-xl font-bold p-2 bg-gray-800 rounded">
                    <span>Dein Gold:</span>
                    <span id="shop-gold-display" class="text-yellow-400">0 üí∞</span>
                </div>
                
                <h3 class="text-xl font-bold text-gray-300 pt-2 border-t border-gray-600">Items (W√§hle 3)</h3>
                <div id="shop-items" class="space-y-3">
                    </div>

                <div class="pt-4 flex justify-between space-x-4">
                    <button onclick="exitShop()" class="smooth-btn bg-green-600 hover:bg-green-700 text-white flex-grow py-3 text-lg">Weiter zum n√§chsten Encounter</button>
                    <button onclick="backToMenuFromShop()" class="smooth-btn bg-gray-600 hover:bg-gray-700 text-white py-3 px-6 text-lg">Aufgeben</button>
                </div>
            </div>
        </div>

        <div id="cosmetics-shop" class="flex-grow flex flex-col justify-center hidden">
            <div class="smooth-panel p-6 space-y-4">
                <h2 class="text-3xl font-black text-center text-purple-400 mb-4">Cosmetics Shop</h2>
                <div class="flex justify-between items-center text-xl font-bold p-2 bg-gray-800 rounded">
                    <span>Deine Punkte:</span>
                    <span id="cosmetics-points-display" class="text-purple-400">0 ‚≠ê</span>
                </div>
                
                <h3 class="text-xl font-bold text-gray-300 pt-2 border-t border-gray-600">Kartenr√ºcken</h3>
                <div id="card-back-shop-items" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    </div>
                
                <button onclick="ui.changeState('MENU')" class="smooth-btn bg-gray-600 hover:bg-gray-700 text-white w-full py-3 text-lg mt-4">Zur√ºck zum Men√º</button>
            </div>
        </div>
        
        <div id="game-over-overlay" class="absolute inset-0 bg-black/90 flex flex-col justify-center items-center z-50 hidden">
            <h1 class="text-6xl font-black text-red-500 mb-6 drop-shadow-xl">GAME OVER</h1>
            <p class="text-xl text-white mb-2">Du hast es bis Encounter <span id="final-floor" class="text-yellow-400 font-bold">1</span> geschafft.</p>
            <p class="text-xl text-white mb-8">Gesammeltes Gold: <span id="final-gold" class="text-yellow-400 font-bold">0</span> üí∞</p>
            <button onclick="resetGame()" class="smooth-btn bg-green-600 hover:bg-green-700 text-white w-64 py-4 text-xl">Neuer Versuch</button>
        </div>

        <div id="info-modal-overlay" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
            <div class="smooth-panel p-6 w-11/12 max-w-md">
                <h2 id="modal-title" class="text-2xl font-black text-center mb-4 text-blue-400">Titel</h2>
                <div id="modal-content" class="text-white space-y-3 max-h-96 overflow-y-auto pr-2">
                    </div>
                <button onclick="closeModal()" class="smooth-btn bg-gray-600 hover:bg-gray-700 text-white w-full py-2 mt-6">Schlie√üen</button>
            </div>
        </div>

    </div>
    <script type="module">
        // --- GAME STATES UND MANAGER ---
        const GAME_STATE = {
            MENU: 'MENU',
            PLAYING: 'PLAYING',
            SHOP: 'SHOP',
            COSMETICS: 'COSMETICS',
            GAMEOVER: 'GAMEOVER'
        };
        
        // Spiel-Modi (Standard Blackjack oder Bosskampf)
        const GAME_MODE = {
            STANDARD: 'STANDARD',
            BOSS: 'BOSS'
        };

        let currentState = GAME_STATE.MENU;
        let deck = [];
        let playerHand = [];
        let dealerHand = [];
        let isGameActive = false;
        
        // Roguelike Status
        let playerHealth = 100;
        let maxHealth = 100;
        let playerGold = 0;
        let currentFloor = 1;
        
        // Modifikatoren
        let goldMultiplier = 1;
        let rerollCharges = 0; 
        
        // BOSS Status
        let gameMode = GAME_MODE.STANDARD;
        let bossHealth = 0;
        let bossMaxHealth = 0;

        // Cosmetics/Progression
        let totalPoints = parseInt(localStorage.getItem('totalPoints') || '0', 10);
        let highscores = JSON.parse(localStorage.getItem('blackjackHighscores') || '[]');
        let unlockedSkins = JSON.parse(localStorage.getItem('unlockedSkins') || '["default"]');
        let equippedSkin = localStorage.getItem('equippedSkin') || 'default';
        
        // Konstanten
        const SUITS = ['‚ô•', '‚ô¶', '‚ô£', '‚ô†'];
        const VALUES = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];

        const ACHIEVEMENTS = [
            { id: 'first_win', name: 'Erster Sieg', condition: () => currentFloor >= 2, points: 10, unlocked: false },
            { id: 'floor_5', name: 'Wegbereiter', condition: () => currentFloor >= 5, points: 50, unlocked: false },
            { id: '100_gold', name: 'Reichtum', condition: () => playerGold >= 100, points: 20, unlocked: false },
            { id: 'first_boss_kill', name: 'Erster Bosskill', condition: () => currentFloor > 10, points: 100, unlocked: false }
        ];
        
        const SHOP_ITEMS_POOL = [
            { id: 'max_hp_boost', name: '+10 Max Health', cost: 30, effect: () => { maxHealth += 10; playerHealth += 10; ui.updateStatus(); showNotification("Max Health erh√∂ht.", 'bg-yellow-500'); } }, 
            { id: 'heal_15', name: 'Heilung (15 HP)', cost: 20, effect: () => { playerHealth = Math.min(maxHealth, playerHealth + 15); ui.updateStatus(); showNotification("Du wurdest geheilt.", 'bg-green-500'); } },
            { id: 'extra_life', name: 'Robuste Haut (+20 HP)', cost: 80, effect: () => { maxHealth += 20; playerHealth += 20; ui.updateStatus(); showNotification("Du f√ºhlst dich robuster.", 'bg-yellow-500'); } }, 
            { id: 'add_reroll_charge', name: 'W√ºrfel-Charge (+1)', cost: 25, effect: () => { rerollCharges += 1; ui.showMessage(`Du hast 1 Charge zum W√ºrfeln erhalten. Aktuell: ${rerollCharges}`, false); showNotification(`+1 W√ºrfel-Charge.`, 'bg-blue-500'); } }, 
            { id: 'gold_double', name: 'Gold-Multiplikator (x2)', cost: 150, effect: () => { goldMultiplier = 2; ui.showMessage('Gold wird ab jetzt verdoppelt! (Einmalig)', false); showNotification('Gold x2 freigeschaltet!', 'bg-yellow-500'); }, available: () => goldMultiplier === 1 }, 
            { id: 'damage_reduction', name: 'Schadensresistenz', cost: 70, effect: () => { playerHealth += 5; ui.updateStatus(); showNotification("Schadensresistenz erworben.", 'bg-gray-500'); } }
        ];
        let currentShopItems = []; 

        const CARD_BACK_SKINS = [
            { id: 'default', name: 'Standard (Lila)', cost: 0, cssClass: 'skin-default' },
            { id: 'gold', name: 'Gold Rush', cost: 100, cssClass: 'skin-gold' },
            { id: 'cyber', name: 'Cyber Grid', cost: 250, cssClass: 'skin-cyber' },
            { id: 'crimson', name: 'Crimson Edge', cost: 500, cssClass: 'skin-crimson' }
        ];

        // --- HILFSFUNKTIONEN ---

        /** Erstellt und mischt ein neues Deck. */
        function createDeck() {
            const newDeck = [];
            for (const suit of SUITS) {
                for (const value of VALUES) {
                    newDeck.push({ suit, value });
                }
            }
            // Fisher-Yates Shuffle
            for (let i = newDeck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newDeck[i], newDeck[j]] = [newDeck[j], newDeck[i]];
            }
            return newDeck;
        }

        /** Berechnet den bestm√∂glichen Blackjack-Score f√ºr eine Hand. */
        function getScore(hand) {
            let score = 0;
            let numAces = 0;
            for (const card of hand) {
                if (card.value === 'A') {
                    numAces++;
                    score += 11;
                } else if (['K', 'Q', 'J'].includes(card.value)) {
                    score += 10;
                } else {
                    score += parseInt(card.value);
                }
            }
            while (score > 21 && numAces > 0) {
                score -= 10;
                numAces--;
            }
            return score;
        }

        /** Zeichnet eine Karte vom Deck. */
        function drawCard() {
            if (deck.length === 0) deck = createDeck();
            return deck.pop();
        }

        /** Erstellt das HTML-Element f√ºr eine Karte. */
        function createCardElement(card, isHidden = false, index = -1) {
            const suitClass = (card.suit === '‚ô•' || card.suit === '‚ô¶') ? 'suit-red' : 'suit-black';
            
            const cardBackSkin = CARD_BACK_SKINS.find(s => s.id === equippedSkin) || CARD_BACK_SKINS[0];
            
            // Inhalt der Karte: Vorderseite oder R√ºckseite
            const content = isHidden 
                ? `<div class="font-black">R21</div>` 
                : `<div class="text-3xl">${card.suit}</div><div class="text-xl">${card.value}</div>`;
                
            const hiddenClass = isHidden 
                ? `card-back ${cardBackSkin.cssClass}` 
                : 'bg-white';
            
            const handSize = playerHand.length + dealerHand.length;
            // K√ºrzere Animation, Delay f√ºr fl√ºssigeren Ablauf
            const delay = 50 * handSize; 
            
            // Reroll Button (wird nur angezeigt, wenn Charges verf√ºgbar sind und es die Spielerkarte ist)
            const rerollButton = (rerollCharges > 0 && !isHidden && index !== -1) ? 
                `<button onclick="rerollCard(${index})" class="text-xs absolute bottom-0 right-0 bg-blue-500 hover:bg-blue-600 text-white p-1 rounded-br-md rounded-tl-md font-bold">R</button>` : '';

            return `
                <div class="card ${suitClass} ${hiddenClass}" data-card-index="${index}" style="animation-delay: ${delay}ms;">
                    ${content}
                    ${rerollButton}
                </div>
            `;
        }
        
        /** Benachrichtigung anzeigen */
        let notificationTimeout;
        function showNotification(message, bgColorClass = 'bg-blue-600', duration = 3000) {
            const el = document.getElementById('notification-box');
            el.innerHTML = message;
            el.className = bgColorClass + ' show'; // Setzt Klasse und zeigt an
            el.classList.remove('hidden');

            clearTimeout(notificationTimeout);
            notificationTimeout = setTimeout(() => {
                el.classList.remove('show');
                setTimeout(() => el.classList.add('hidden'), 500); // Verz√∂gerung f√ºr CSS-√úbergang
            }, duration);
        }

        /** Spieler kann eine Karte neu ziehen (kostet eine Charge). */
        window.rerollCard = function(index) {
            if (!isGameActive || rerollCharges <= 0 || index < 0 || index >= playerHand.length) return;
            
            rerollCharges -= 1; // Charge verbrauchen
            
            // Karte ersetzen
            playerHand.splice(index, 1, drawCard());
            
            ui.updateHands(false);
            ui.showMessage(`Karte neu gew√ºrfelt! (${rerollCharges} Charges √ºbrig)`, false);
            ui.updateStatus();
            
            // Nach dem W√ºrfeln sofort auf Bust/21 pr√ºfen
            const playerScore = getScore(playerHand);
            if (playerScore > 21) {
                endGame("Bust nach dem W√ºrfeln!", false);
            } else if (playerScore === 21) {
                stand();
            }
        }
        
        /** Speichert Highscore und Punkte */
        function saveHighscore() {
            const newScore = {
                floor: currentFloor,
                gold: playerGold,
                date: new Date().toISOString().slice(0, 10)
            };
            highscores.push(newScore);
            highscores.sort((a, b) => b.floor - a.floor || b.gold - a.gold);
            
            // Max. 10 Highscores behalten
            highscores = highscores.slice(0, 10); 
            
            localStorage.setItem('blackjackHighscores', JSON.stringify(highscores));
            localStorage.setItem('totalPoints', totalPoints.toString());
            
            // Pr√ºfe Achievments nur am Ende eines Runs
            checkAchievements();
        }

        /** Achievement-Pr√ºfung */
        function checkAchievements() {
            let pointsGained = 0;
            ACHIEVEMENTS.forEach(a => {
                if (!a.unlocked && a.condition()) {
                    a.unlocked = true;
                    totalPoints += a.points;
                    pointsGained += a.points;
                    showNotification(`ACHIEVEMENT: ${a.name} freigeschaltet! (+${a.points} ‚≠ê)`, 'bg-yellow-600', 5000);
                }
            });
            if (pointsGained > 0) {
                localStorage.setItem('totalPoints', totalPoints.toString());
            }
            localStorage.setItem('achievements', JSON.stringify(ACHIEVEMENTS));
        }

        // --- UI Controller ---

        const ui = {
            // Element IDs
            dealerHandEl: document.getElementById('dealer-hand'),
            playerHandEl: document.getElementById('player-hand'),
            playerScoreEl: document.getElementById('player-score'),
            playerHealthEl: document.getElementById('player-health'),
            playerGoldEl: document.getElementById('player-gold'),
            currentFloorEl: document.getElementById('current-floor'),
            rerollChargesEl: document.getElementById('reroll-charges-display'),
            messageBoxEl: document.getElementById('message-box'),
            btnHit: document.getElementById('btn-hit'),
            btnStand: document.getElementById('btn-stand'),
            dealerTitleEl: document.getElementById('dealer-title'),
            gameOverOverlay: document.getElementById('game-over-overlay'),
            bossStatusBarEl: document.getElementById('boss-status-bar'),
            bossHealthEl: document.getElementById('boss-health'),
            bossHealthBarEl: document.getElementById('boss-health-bar'),

            mainMenuEl: document.getElementById('main-menu'),
            shopContainerEl: document.getElementById('shop-container'),
            gameplayStateEl: document.getElementById('gameplay-state'),
            cosmeticsShopEl: document.getElementById('cosmetics-shop'),
            shopGoldDisplayEl: document.getElementById('shop-gold-display'),
            cosmeticsPointsDisplayEl: document.getElementById('cosmetics-points-display'),
            shopItemsEl: document.getElementById('shop-items'),
            infoModalOverlay: document.getElementById('info-modal-overlay'),
            modalTitleEl: document.getElementById('modal-title'),
            modalContentEl: document.getElementById('modal-content'),
            totalPointsEl: document.getElementById('total-points'),


            // Methoden
            updateHands(revealDealer = false) {
                this.dealerHandEl.innerHTML = dealerHand.map((card, index) =>
                    createCardElement(card, !revealDealer && index === 0)
                ).join('');

                // √úbergibt den Index, damit der Reroll-Button wei√ü, welche Karte gewechselt werden soll
                this.playerHandEl.innerHTML = playerHand.map((card, index) => createCardElement(card, false, index)).join('');

                const score = getScore(playerHand);
                this.playerScoreEl.textContent = score;

                if (revealDealer) {
                    this.dealerTitleEl.textContent = `Dealer's Hand (${getScore(dealerHand)})`;
                } else {
                    this.dealerTitleEl.textContent = "Dealer's Hand";
                }
            },

            updateStatus() {
                this.playerHealthEl.textContent = `${playerHealth}/${maxHealth} ‚ù§Ô∏è`;
                this.playerGoldEl.textContent = `${playerGold} üí∞`;
                this.currentFloorEl.textContent = `Encounter ${currentFloor}`;
                this.totalPointsEl.textContent = totalPoints;
                this.shopGoldDisplayEl.textContent = playerGold;
                this.cosmeticsPointsDisplayEl.textContent = totalPoints;
                this.rerollChargesEl.textContent = `W√ºrfel: ${rerollCharges}`;
                
                // NEU: Boss Status
                if (gameMode === GAME_MODE.BOSS) {
                    this.bossStatusBarEl.classList.remove('hidden');
                    this.bossHealthEl.textContent = `${bossHealth}/${bossMaxHealth}`;
                    const percent = (bossHealth / bossMaxHealth) * 100;
                    this.bossHealthBarEl.style.width = `${percent}%`;
                } else {
                    this.bossStatusBarEl.classList.add('hidden');
                }
            },

            showMessage(message, isEndState = false) {
                this.messageBoxEl.innerHTML = message;
                this.messageBoxEl.classList.remove('text-green-400', 'text-red-400', 'text-yellow-400');
                if (isEndState) {
                    this.messageBoxEl.classList.add(message.includes('Gewonnen') || message.includes('BOSS besiegt') ? 'text-green-400' : 'text-red-400');
                    this.messageBoxEl.classList.add('bg-black/20');
                } else {
                    this.messageBoxEl.classList.add('text-yellow-400');
                    this.messageBoxEl.classList.remove('bg-black/20');
                }
            },

            setControls(active) {
                this.btnHit.disabled = !active;
                this.btnStand.disabled = !active;
            },
            
            changeState(newState) {
                this.mainMenuEl.classList.add('hidden');
                this.gameplayStateEl.classList.add('hidden');
                this.shopContainerEl.classList.add('hidden');
                this.cosmeticsShopEl.classList.add('hidden');
                this.gameOverOverlay.classList.add('hidden');
                this.infoModalOverlay.classList.add('hidden');
                
                switch (newState) {
                    case GAME_STATE.MENU:
                        this.mainMenuEl.classList.remove('hidden');
                        break;
                    case GAME_STATE.PLAYING:
                        this.gameplayStateEl.classList.remove('hidden');
                        break;
                    case GAME_STATE.SHOP:
                        this.shopContainerEl.classList.remove('hidden');
                        break;
                    case GAME_STATE.COSMETICS:
                        this.cosmeticsShopEl.classList.remove('hidden');
                        break;
                    case GAME_STATE.GAMEOVER:
                        this.showGameOver();
                        break;
                }
                currentState = newState;
                this.updateStatus();
            },

            showGameOver() {
                document.getElementById('final-floor').textContent = currentFloor;
                document.getElementById('final-gold').textContent = playerGold;
                this.gameOverOverlay.classList.remove('hidden');
            },
        };

        // --- SHOP FUNKTIONEN ---

        function generateShopItems() {
            // Filtern der verf√ºgbaren Items (z.B. Gold Multiplier nur einmal)
            const availableItems = SHOP_ITEMS_POOL.filter(item => !item.available || item.available());
            
            // 3 zuf√§llige, eindeutige Items ausw√§hlen
            currentShopItems = [];
            const tempItems = [...availableItems]; // Kopie des Arrays
            while (currentShopItems.length < 3 && tempItems.length > 0) {
                const randomIndex = Math.floor(Math.random() * tempItems.length);
                currentShopItems.push(tempItems[randomIndex]);
                tempItems.splice(randomIndex, 1); 
            }
        }
        
        function renderShop() {
            generateShopItems();
            let html = '';
            currentShopItems.forEach((item, index) => {
                const canAfford = playerGold >= item.cost;
                html += `
                    <div class="flex justify-between items-center smooth-panel p-3 ${canAfford ? 'border-green-500/50' : 'border-red-500/50'}">
                        <div>
                            <p class="text-lg font-bold text-white">${item.name}</p>
                            <p class="text-sm text-gray-400">${item.id === 'damage_reduction' ? 'Reduziert den erlittenen Schaden.' : 'Einmaliger Effekt.'}</p>
                        </div>
                        <button onclick="buyShopItem(${index})" 
                                class="smooth-btn py-2 px-4 text-sm ${canAfford ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-500 cursor-not-allowed'}"
                                ${!canAfford ? 'disabled' : ''}>
                            ${item.cost} üí∞
                        </button>
                    </div>
                `;
            });
            ui.shopItemsEl.innerHTML = html;
            ui.updateStatus(); // Aktualisiert die Goldanzeige im Shop
        }

        window.buyShopItem = function(index) {
            const item = currentShopItems[index];
            if (!item || playerGold < item.cost) {
                showNotification("Nicht genug Gold!", 'bg-red-500');
                return;
            }
            
            playerGold -= item.cost;
            item.effect();
            
            // Entferne das gekaufte Item aus der aktuellen Shop-Liste und rendere neu
            currentShopItems.splice(index, 1);
            renderShop();
        }

        window.exitShop = function() {
            currentFloor++; // N√§chster Encounter nach dem Shop
            ui.changeState(GAME_STATE.PLAYING);
            startEncounter();
        }

        // --- MODAL & COSMETICS FUNKTIONEN ---

        window.showHighscores = function() {
            ui.modalTitleEl.textContent = 'Highscores (Encounter / Gold)';
            let content = '<p class="text-center text-gray-400">Noch keine Highscores gespeichert.</p>';
            if (highscores.length > 0) {
                content = '<ul class="space-y-2">';
                highscores.forEach((score, index) => {
                    content += `<li class="flex justify-between items-center p-2 rounded ${index === 0 ? 'bg-yellow-800/50 border-yellow-500 border' : 'bg-gray-700/50'}">
                        <span class="font-bold">${index + 1}.</span>
                        <span>Encounter: <span class="text-green-300">${score.floor}</span></span>
                        <span>Gold: <span class="text-yellow-300">${score.gold} üí∞</span></span>
                        <span class="text-xs text-gray-400">${score.date}</span>
                    </li>`;
                });
                content += '</ul>';
            }
            ui.modalContentEl.innerHTML = content;
            ui.infoModalOverlay.classList.remove('hidden');
        }

        window.showAchievements = function() {
            ui.modalTitleEl.textContent = 'Achievements';
            let content = '<ul class="space-y-2">';
            ACHIEVEMENTS.forEach(a => {
                const isUnlocked = a.unlocked;
                content += `<li class="flex justify-between items-center p-3 rounded ${isUnlocked ? 'bg-green-800/50 border-green-500' : 'bg-gray-700/50 border-gray-600'} border">
                    <div>
                        <p class="text-lg font-bold ${isUnlocked ? 'text-green-300' : 'text-gray-300'}">${a.name}</p>
                        <p class="text-xs text-gray-400">${isUnlocked ? 'Freigeschaltet' : 'Bedingung nicht erf√ºllt'}</p>
                    </div>
                    <span class="font-black text-xl">${a.points} ‚≠ê</span>
                </li>`;
            });
            content += '</ul>';
            ui.modalContentEl.innerHTML = content;
            ui.infoModalOverlay.classList.remove('hidden');
        }

        window.closeModal = function() {
            ui.infoModalOverlay.classList.add('hidden');
        }

        window.showCosmeticsShop = function() {
            ui.changeState(GAME_STATE.COSMETICS);
            renderCosmeticsShop();
        }

        function renderCosmeticsShop() {
            const container = document.getElementById('card-back-shop-items');
            let html = '';
            
            CARD_BACK_SKINS.forEach(skin => {
                const isUnlocked = unlockedSkins.includes(skin.id);
                const isEquipped = equippedSkin === skin.id;
                const canBuy = totalPoints >= skin.cost;
                
                html += `
                    <div class="smooth-panel p-4 text-center flex flex-col items-center justify-between border-2 ${isEquipped ? 'border-purple-400' : isUnlocked ? 'border-green-400' : 'border-gray-700'}">
                        <p class="font-bold text-lg mb-2 ${isEquipped ? 'text-purple-300' : 'text-white'}">${skin.name}</p>
                        <div class="card card-back w-20 h-28 my-2 ${skin.cssClass} !transform-none !opacity-100">R21</div>
                        
                        ${isEquipped ? 
                            `<span class="text-lg font-black text-purple-400 mt-2">AUSGER√úSTET</span>` 
                            : isUnlocked ? 
                                `<button onclick="equipSkin('${skin.id}')" class="smooth-btn bg-green-600 hover:bg-green-700 text-white w-full py-2 text-sm mt-2">Ausr√ºsten</button>` 
                                : 
                                `<button onclick="buySkin('${skin.id}', ${skin.cost})" 
                                        class="smooth-btn w-full py-2 text-sm mt-2 ${canBuy ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-gray-500 cursor-not-allowed'}" 
                                        ${!canBuy ? 'disabled' : ''}>
                                    Kaufen (${skin.cost} ‚≠ê)
                                </button>`
                        }
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        window.buySkin = function(skinId, cost) {
            if (totalPoints < cost) {
                showNotification("Nicht genug Punkte!", 'bg-red-500');
                return;
            }
            totalPoints -= cost;
            unlockedSkins.push(skinId);
            localStorage.setItem('totalPoints', totalPoints.toString());
            localStorage.setItem('unlockedSkins', JSON.stringify(unlockedSkins));
            showNotification(`${CARD_BACK_SKINS.find(s => s.id === skinId).name} freigeschaltet!`, 'bg-green-600');
            renderCosmeticsShop();
        }

        window.equipSkin = function(skinId) {
            equippedSkin = skinId;
            localStorage.setItem('equippedSkin', skinId);
            showNotification(`Neuer Kartenr√ºcken: ${CARD_BACK_SKINS.find(s => s.id === skinId).name}!`, 'bg-purple-600');
            renderCosmeticsShop();
        }


        // --- SPIEL-LOOP LOGIK ---
        
        /** Initialisiert die Daten f√ºr einen neuen Run. */
        window.startNewRun = function() {
            // Wichtig: Setze die Spieler-HP auf den Max-Wert ZUR SICHERHEIT
            playerHealth = 100;
            maxHealth = 100;
            playerGold = 0;
            currentFloor = 1; // Startet auf Encounter 1
            goldMultiplier = 1;
            rerollCharges = 0; 
            bossHealth = 0; 
            gameMode = GAME_MODE.STANDARD;
            
            ui.changeState(GAME_STATE.PLAYING);
            startEncounter();
        }

        /** Setzt den Spielstand zur√ºck und startet einen neuen Run. */
        window.resetGame = function() {
            ui.changeState(GAME_STATE.MENU);
        }
        
        window.backToMenuFromShop = function() {
            saveHighscore(); 
            showNotification(`Run auf Encounter ${currentFloor} aufgegeben.`, 'bg-red-500');
            ui.changeState(GAME_STATE.MENU);
        }

        /** Startet eine neue Blackjack-Runde f√ºr den aktuellen Floor. */
        window.startEncounter = function() {
            if (playerHealth <= 0) return ui.changeState(GAME_STATE.GAMEOVER);

            // NEU: Boss Check (alle 10 Encounter)
            if (currentFloor > 0 && currentFloor % 10 === 0) {
                if (gameMode !== GAME_MODE.BOSS || bossHealth <= 0) {
                    gameMode = GAME_MODE.BOSS;
                    bossMaxHealth = 50 + (currentFloor / 10) * 15;
                    bossHealth = bossMaxHealth;
                    showNotification(`BOSS ALARM! Encounter ${currentFloor} - Das ist der Endgegner!`, 'bg-red-700', 5000);
                } else {
                    showNotification(`Runde ${currentFloor} - Kampf fortgesetzt!`, 'bg-red-500', 1000);
                    gameMode = GAME_MODE.BOSS; 
                }
            } else {
                gameMode = GAME_MODE.STANDARD;
                bossHealth = 0; 
            }

            deck = createDeck();
            playerHand = [];
            dealerHand = [];
            isGameActive = true;

            // Startkarten 
            for (let i = 0; i < 2; i++) {
                playerHand.push(drawCard());
            }
            dealerHand.push(drawCard(), drawCard());

            ui.updateHands(false);
            ui.updateStatus();
            ui.setControls(true);
            ui.showMessage(`Encounter ${currentFloor}: Mach deinen Zug! ${gameMode === GAME_MODE.BOSS ? '‚Äî BOSS FIGHT!' : ''}`);
            
            checkBlackjack();
        }

        /** √úberpr√ºft auf Blackjack zu Beginn */
        function checkBlackjack() {
            const playerScore = getScore(playerHand);
            const dealerScore = getScore(dealerHand);

            if (playerScore === 21) {
                // K√ºrzere Timeout f√ºr fl√ºssigeren Ablauf
                setTimeout(() => ui.updateHands(true), 300); 

                if (dealerScore === 21) {
                    endGame("Push! Unentschieden.", true, true);
                } else {
                    endGame("BLACKJACK! Du gewinnst.", true);
                }
            } else if (dealerScore === 21) {
                // K√ºrzere Timeout f√ºr fl√ºssigeren Ablauf
                setTimeout(() => ui.updateHands(true), 300); 
                endGame("Dealer Blackjack!", false);
            }
        }

        /** Spieler zieht eine Karte. */
        window.hit = function() {
            if (!isGameActive) return;

            playerHand.push(drawCard());
            // K√ºrzere Timeout f√ºr fl√ºssigeren Ablauf
            setTimeout(() => {
                ui.updateHands(false);

                const playerScore = getScore(playerHand);

                if (playerScore > 21) {
                    endGame("Bust! Du hast √ºberkauft.", false);
                } else if (playerScore === 21) {
                    stand();
                }
            }, 200); 
        }

        /** Spieler bleibt stehen, Dealer ist an der Reihe. */
        window.stand = function() {
            if (!isGameActive) return;

            ui.setControls(false);
            ui.updateHands(true); 

            let dealerInterval = setInterval(() => {
                let dealerScore = getScore(dealerHand);
                if (dealerScore < 17) {
                    dealerHand.push(drawCard());
                    ui.updateHands(true);
                } else {
                    clearInterval(dealerInterval);
                    evaluateResult();
                }
            }, 400); // Dealer-Geschwindigkeit angepasst f√ºr fl√ºssigere Animation
        }

        /** Auswertung des Ergebnisses nach Dealer-Zug. */
        function evaluateResult() {
            const dealerScore = getScore(dealerHand);
            const playerScore = getScore(playerHand);
            
            if (dealerScore > 21) {
                endGame("Dealer Bust! Du gewinnst!", true);
            } else if (playerScore > dealerScore) {
                endGame("Du hast gewonnen!", true);
            } else if (playerScore < dealerScore) {
                endGame("Der Dealer gewinnt!", false);
            } else {
                endGame("Push! Unentschieden.", true, true);
            }
        }

        /** Beendet die Runde und berechnet Gewinn/Verlust. */
        function endGame(message, playerWon, isPush = false) {
            isGameActive = false;
            ui.setControls(false);
            ui.updateHands(true); // Deckt die Dealer-Karte auf

            let goldChange = 0;
            let healthDamage = 0;

            if (isPush) {
                ui.showMessage(message, true);
                setTimeout(nextAction, 1500);
                return; 
            }
            
            if (playerWon) {
                // ENCOUNTER Z√ÑHLT NUR IM STANDARD-MODUS HOCH
                if (gameMode === GAME_MODE.STANDARD) {
                    currentFloor++; 
                }
                
                // Gewinn: Gold und Boss-Schaden
                if (gameMode === GAME_MODE.BOSS) {
                    const damage = getScore(playerHand);
                    bossHealth -= damage;
                    
                    if (bossHealth <= 0) {
                        message = "BOSS besiegt! Du erh√§ltst Bonus-Gold.";
                        goldChange = Math.floor(100 * goldMultiplier);
                        gameMode = GAME_MODE.STANDARD; 
                        currentFloor++; // N√§chsten Encounter nach BOSS-Sieg laden
                    } else {
                        message = `BOSS Schaden: ${damage}! HP: ${bossHealth}/${bossMaxHealth}.`;
                        goldChange = Math.floor(20 * goldMultiplier); 
                    }

                } else {
                    // Standard-Gewinn
                    goldChange = Math.floor(25 * goldMultiplier);
                }
                playerGold += goldChange;
                ui.showMessage(`${message} (+${goldChange} üí∞)`, true);

            } else {
                // Verlust: Schaden erleiden
                if (gameMode === GAME_MODE.BOSS) {
                    healthDamage = Math.floor(20 + (currentFloor / 10) * 5); 
                    if (message.includes("Bust")) healthDamage = Math.floor(healthDamage / 2);

                } else {
                    healthDamage = Math.floor(10 + currentFloor * 1.5);
                }
                
                playerHealth -= healthDamage;
                if (playerHealth <= 0) {
                    playerHealth = 0; 
                    ui.showMessage(`${message} (-${healthDamage} ‚ù§Ô∏è)`, true);
                    saveHighscore(); 
                    setTimeout(() => ui.changeState(GAME_STATE.GAMEOVER), 2000);
                    return; 
                }
                
                ui.showMessage(`${message} (-${healthDamage} ‚ù§Ô∏è)`, true);
            }

            ui.updateStatus();
            setTimeout(nextAction, 1500); // 1.5 Sekunden warten, dann fortfahren
        }
        
        /** Entscheidet, was als N√§chstes passiert: Shop oder neuer Encounter */
        function nextAction() {
            if (playerHealth <= 0) {
                saveHighscore();
                ui.changeState(GAME_STATE.GAMEOVER);
                return;
            }

            // Wenn im Boss-Modus verloren, Bosskampf fortsetzen
            if (gameMode === GAME_MODE.BOSS && bossHealth > 0) {
                startEncounter(); 
                return;
            }
            
            // Standard: Nach 3 normalen Encountern kommt der Shop (currentFloor wurde bei Sieg bereits erh√∂ht)
            // Pr√ºfen, ob der Floor nach dem letzten Spiel auf 2, 3, 5, 6, 8, 9... steht (d.h. nach 3 Encountern)
            if (currentFloor > 1 && (currentFloor-1) % 3 === 0 && currentFloor % 10 !== 0) {
                renderShop();
                ui.changeState(GAME_STATE.SHOP);
            } else {
                // Weiter zum n√§chsten Encounter (egal ob Sieg oder Niederlage)
                startEncounter();
            }
        }
        
        // --- INITIALISIERUNG (Start der App) ---
        
        /** Startet die gesamte Anwendung. */
        function initialize() {
            // Lade Achievments und andere gespeicherte Werte
            const storedAchievements = JSON.parse(localStorage.getItem('achievements') || '[]');
            storedAchievements.forEach(storedA => {
                const index = ACHIEVEMENTS.findIndex(a => a.id === storedA.id);
                if (index !== -1) {
                    ACHIEVEMENTS[index].unlocked = storedA.unlocked;
                }
            });
            
            // WICHTIG: Setze die Spieler-HP explizit auf 100, um den "Sofort Game Over" Fehler zu beheben
            playerHealth = 100;
            maxHealth = 100;

            ui.updateStatus();
            ui.changeState(GAME_STATE.MENU); 
            
            // Verstecke das Game-Over Overlay sofort
            document.getElementById('game-over-overlay').classList.add('hidden');
        }

        // Starte die App, wenn das Dokument vollst√§ndig geladen ist
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>